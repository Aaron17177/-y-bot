{"cells":[{"cell_type":"code","source":["# ==========================================\n","# Gemini V37 Auto Commander (GitHub Actions ç‰ˆ) - Messaging API å‡ç´šç‰ˆ\n","# ------------------------------------------\n","# åŠŸèƒ½ï¼šè‡ªå‹•æŠ“å–æ•¸æ“š -> è¨“ç·´æ¨¡å‹ -> åˆ¤æ–·è¶¨å‹¢ -> ç™¼é€ LINE è¨Šæ¯\n","# æ›´æ–°ï¼šå·²å¾ LINE Notify é·ç§»è‡³ LINE Messaging API\n","# æ›´æ–°2ï¼šè¨Šæ¯å…§å®¹æ“´å……ï¼ŒåŒ…å«å®Œæ•´æˆ°æƒ…å®¤è³‡è¨Š\n","# ==========================================\n","\n","import os\n","import requests\n","import json\n","import warnings\n","import yfinance as yf\n","import pandas as pd\n","import numpy as np\n","from stable_baselines3 import PPO\n","import gymnasium as gym\n","from gymnasium import spaces\n","\n","warnings.filterwarnings(\"ignore\")\n","\n","# å¾ç’°å¢ƒè®Šæ•¸è®€å– LINE Messaging API è¨­å®š\n","LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')\n","LINE_USER_ID = os.environ.get('LINE_USER_ID')\n","\n","def send_line_push(msg):\n","    if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_USER_ID:\n","        print(\"âŒ æœªè¨­å®š LINE_CHANNEL_ACCESS_TOKEN æˆ– LINE_USER_IDï¼Œç„¡æ³•ç™¼é€é€šçŸ¥\")\n","        print(\"--- è¨Šæ¯å…§å®¹ ---\")\n","        print(msg)\n","        return\n","\n","    url = 'https://api.line.me/v2/bot/message/push'\n","    headers = {\n","        'Content-Type': 'application/json',\n","        'Authorization': f'Bearer {LINE_CHANNEL_ACCESS_TOKEN}'\n","    }\n","\n","    # Messaging API çš„ Payload æ ¼å¼\n","    payload = {\n","        \"to\": LINE_USER_ID,\n","        \"messages\": [\n","            {\n","                \"type\": \"text\",\n","                \"text\": msg\n","            }\n","        ]\n","    }\n","\n","    try:\n","        response = requests.post(url, headers=headers, json=payload)\n","        if response.status_code == 200:\n","            print(\"âœ… Line è¨Šæ¯ç™¼é€æˆåŠŸ\")\n","        else:\n","            print(f\"âŒ Line ç™¼é€å¤±æ•—: {response.status_code}\")\n","            print(response.text)\n","    except Exception as e:\n","        print(f\"âŒ é€£ç·šéŒ¯èª¤: {e}\")\n","\n","# ==========================================\n","# 1. æ•¸æ“šç²å–èˆ‡ç‰¹å¾µå·¥ç¨‹\n","# ==========================================\n","print(\"æ­£åœ¨é€£ç·šæ•¸æ“šåº«...\")\n","START_DATE = '2015-01-01'\n","tickers = ['BTC-USD', '^VIX']\n","raw_data = yf.download(tickers, start=START_DATE, group_by='ticker', progress=False)\n","\n","df = pd.DataFrame()\n","try:\n","    if 'BTC-USD' in raw_data.columns:\n","        df['Close'] = raw_data['BTC-USD']['Close']\n","    elif 'Close' in raw_data.columns:\n","        df['Close'] = raw_data['Close']\n","\n","    if '^VIX' in raw_data.columns:\n","        df['VIX'] = raw_data['^VIX']['Close']\n","    else:\n","        df['VIX'] = 20.0\n","except KeyError:\n","    df['Close'] = raw_data.iloc[:, 0]\n","    df['VIX'] = 20.0\n","\n","df.ffill(inplace=True)\n","df.dropna(inplace=True)\n","\n","# æŒ‡æ¨™è¨ˆç®—\n","df['SMA_140'] = df['Close'].rolling(window=140).mean()\n","df['Dist_Trend'] = (df['Close'] - df['SMA_140']) / df['SMA_140']\n","df['SMA_200'] = df['Close'].rolling(window=200).mean()\n","df['Mayer'] = df['Close'] / df['SMA_200']\n","df['VIX_Level'] = df['VIX'] / 30.0\n","\n","def calculate_rsi(series, period=14):\n","    delta = series.diff()\n","    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()\n","    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()\n","    rs = gain / loss\n","    return 100 - (100 / (1 + rs))\n","df['RSI'] = calculate_rsi(df['Close'])\n","\n","df.dropna(inplace=True)\n","train_df = df.copy()\n","\n","# ==========================================\n","# 2. AI ç’°å¢ƒ\n","# ==========================================\n","class GeminiFinalEnv(gym.Env):\n","    def __init__(self, dataframe):\n","        super(GeminiFinalEnv, self).__init__()\n","        self.df = dataframe\n","        self.current_step = 0\n","        self.action_space = spaces.Discrete(3)\n","        self.observation_space = spaces.Box(low=-np.inf, high=np.inf, shape=(5,), dtype=np.float32)\n","        self.holdings = 0.0\n","\n","    def reset(self, seed=None, options=None):\n","        super().reset(seed=seed)\n","        self.current_step = 0\n","        self.holdings = 0.0\n","        return self._next_observation(), {}\n","\n","    def _next_observation(self):\n","        obs = np.array([\n","            self.df['Dist_Trend'].iloc[self.current_step],\n","            self.df['Mayer'].iloc[self.current_step] / 3.0,\n","            self.df['VIX_Level'].iloc[self.current_step],\n","            self.df['RSI'].iloc[self.current_step] / 100,\n","            float(self.holdings)\n","        ], dtype=np.float32)\n","        return np.nan_to_num(obs)\n","\n","    def step(self, action):\n","        self.current_step += 1\n","        target_pct = {0: 0.0, 1: 0.5, 2: 1.0}[int(action)]\n","\n","        # é¢¨æ§é‚è¼¯\n","        if self.df['Mayer'].iloc[self.current_step] > 2.4:\n","            target_pct = min(target_pct, 0.5)\n","        if self.df['Dist_Trend'].iloc[self.current_step] < 0:\n","            if self.df['RSI'].iloc[self.current_step] > 30:\n","                target_pct = 0.0\n","        if self.df['VIX_Level'].iloc[self.current_step] > 1.0:\n","            target_pct = 0.0\n","\n","        btc_ret = self.df['Close'].iloc[self.current_step] / self.df['Close'].iloc[self.current_step-1] - 1\n","        reward = target_pct * btc_ret * 100\n","        if self.df['Dist_Trend'].iloc[self.current_step] > 0 and target_pct == 1.0:\n","            reward += 0.01\n","\n","        done = self.current_step >= len(self.df) - 2\n","        return self._next_observation(), reward, done, False, {}\n","\n","# ==========================================\n","# 3. è¨“ç·´èˆ‡é æ¸¬\n","# ==========================================\n","print(\"AI æ­£åœ¨åˆ†ææ­·å²æ•¸æ“š...\")\n","env_train = GeminiFinalEnv(train_df)\n","model = PPO(\"MlpPolicy\", env_train, verbose=0, learning_rate=0.0003, ent_coef=0.01)\n","# ç‚ºäº†ç¯€çœ GitHub è³‡æºï¼Œæ¯æ—¥åŸ·è¡Œè¨“ç·´æ­¥æ•¸å¯ç¨å¾®é™ä½ï¼Œå› ç‚ºæ¨¡å‹çµæ§‹ç°¡å–®\n","model.learn(total_timesteps=30000)\n","\n","# ç”Ÿæˆä»Šæ—¥è¨Šè™Ÿ\n","env_live = GeminiFinalEnv(train_df)\n","obs, _ = env_live.reset()\n","for _ in range(len(train_df) - 1):\n","    action, _ = model.predict(obs)\n","    env_live.step(action)\n","    obs = env_live._next_observation()\n","\n","raw_action, _ = model.predict(obs)\n","raw_action = int(raw_action)\n","\n","# ==========================================\n","# 4. ç”Ÿæˆ Line å ±å‘Š\n","# ==========================================\n","latest_data = df.iloc[-1]\n","latest_date = df.index[-1].strftime('%Y-%m-%d')\n","latest_price = latest_data['Close']\n","sma140 = latest_data['SMA_140']\n","mayer = latest_data['Mayer']\n","vix = latest_data['VIX']\n","rsi = latest_data['RSI']\n","\n","target_pct = {0: 0.0, 1: 0.5, 2: 1.0}[raw_action]\n","status_icon = \"âšª\"\n","short_msg = \"\"\n","long_reason = \"\" # æ–°å¢è©³ç´°ç†ç”±\n","\n","# é¢¨æ§é‡ç¾\n","is_bull = latest_data['Dist_Trend'] > 0\n","is_overheated = latest_data['Mayer'] > 2.4\n","is_oversold = latest_data['RSI'] < 30\n","is_panic = latest_data['VIX'] > 30\n","\n","if is_panic:\n","    target_pct = 0.0\n","    status_icon = \"ğŸŒªï¸\"\n","    short_msg = \"ææ…Œé¿éšª (Cash Only)\"\n","    long_reason = \"VIX æŒ‡æ•¸éé«˜ (>30)ï¼Œå¸‚å ´æ¥µåº¦ä¸ç©©ï¼Œå¼·åˆ¶ç©ºå€‰ä¿å‘½ã€‚\"\n","elif is_overheated:\n","    target_pct = min(target_pct, 0.5)\n","    status_icon = \"âš ï¸\"\n","    short_msg = \"éç†±æ¸›ç¢¼ (Max 50%)\"\n","    long_reason = \"Mayer å€æ•¸ > 2.4ï¼Œåƒ¹æ ¼åš´é‡åé›¢å‡ç·šï¼Œå¼·åˆ¶æ¸›ç¢¼é–å®šåˆ©æ½¤ã€‚\"\n","elif not is_bull:\n","    if is_oversold:\n","        status_icon = \"âš¡\"\n","        short_msg = \"ç†Šå¸‚æ¶åå½ˆ (High Risk)\"\n","        long_reason = \"é›–ç„¶è™•æ–¼ç†Šå¸‚ (åƒ¹æ ¼ < 140æ—¥ç·š)ï¼Œä½† RSI è¶…è³£ï¼Œå˜—è©¦æ¶çŸ­ (é«˜é¢¨éšª)ã€‚\"\n","    else:\n","        target_pct = 0.0\n","        status_icon = \"ğŸ›‘\"\n","        short_msg = \"ç©ºå€‰è§€æœ› (Trend Off)\"\n","        long_reason = \"ã€ç†Šå¸‚é˜²ç¦¦ã€‘åƒ¹æ ¼è·Œç ´ 140æ—¥ç”Ÿå‘½ç·šï¼Œä¸”ç„¡è¶…è³£è¨Šè™Ÿï¼Œå¼·åˆ¶ç©ºå€‰ç­‰å¾…è¶¨å‹¢å›ç©©ã€‚\"\n","else:\n","    if raw_action == 2:\n","        status_icon = \"ğŸš€\"\n","        short_msg = \"æ»¿å€‰é€²æ”» (Full BTC)\"\n","        long_reason = \"ã€é †å‹¢é€²æ”»ã€‘åƒ¹æ ¼ç«™ç©© 140æ—¥ç·šï¼Œä¼°å€¼åˆç†ï¼Œå‹•èƒ½å¼·å‹ã€‚å»ºè­°æ»¿å€‰æŒæœ‰ã€‚\"\n","    elif raw_action == 1:\n","        status_icon = \"âš–ï¸\"\n","        short_msg = \"åŠå€‰éœ‡ç›ª (50% BTC)\"\n","        long_reason = \"ã€éœ‡ç›ªæŒæœ‰ã€‘è¶¨å‹¢å‘ä¸Šä½†å‹•èƒ½æ¸›å¼±ï¼Œå»ºè­°åŠå€‰æŒæœ‰ï¼Œé€²å¯æ”»é€€å¯å®ˆã€‚\"\n","    else:\n","        status_icon = \"ğŸ›¡ï¸\"\n","        short_msg = \"ä¿å®ˆè§€æœ›\"\n","        long_reason = \"ã€ä¿å®ˆè§€æœ›ã€‘è¶¨å‹¢é›–å‘ä¸Šï¼Œä½† AI åµæ¸¬åˆ°æ½›åœ¨é¢¨éšªï¼Œé¸æ“‡æš«æ™‚ç©ºå€‰ã€‚\"\n","\n","# è¨ˆç®—å»ºè­°é‡‘é¡ (ç¯„ä¾‹æœ¬é‡‘: 100è¬)\n","base_capital = 1000000\n","btc_amount = base_capital * target_pct\n","cash_amount = base_capital * (1 - target_pct)\n","\n","# çµ„åˆå®Œæ•´è¨Šæ¯ (Rich Message)\n","message = f\"\"\"\n","=========================\n","ğŸ† Gemini V37 å¯¦æˆ°æˆ°æƒ…å®¤\n","ğŸ“… æ•¸æ“šæ—¥æœŸ: {latest_date}\n","=========================\n","\n","ğŸ“Š [å¸‚å ´å¥åº·åº¦é«”æª¢]\n","   ğŸ’° BTC åƒ¹æ ¼ : ${latest_price:,.2f}\n","   ğŸ“ˆ è¶¨å‹¢ç·š (140MA): ${sma140:,.2f}   {'âœ… å¤šé ­' if is_bull else 'âŒ ç©ºé ­'}\n","   ğŸŒ¡ï¸ ä¼°å€¼ (Mayer): {mayer:.2f}        {'ğŸ”¥ éç†±' if is_overheated else 'â„ï¸ åˆç†'}\n","   ğŸŒŠ ææ…Œ (VIX)  : {vix:.2f}        {'ğŸŒªï¸ ææ…Œ' if is_panic else 'ğŸ˜Œ ç©©å®š'}\n","   âš¡ å‹•èƒ½ (RSI)  : {rsi:.2f}\n","\n","ğŸ“¢ [AI æŒ‡æ®å®˜æŒ‡ä»¤]\n","   {status_icon} {long_reason}\n","\n","ğŸ’¼ [å»ºè­°å€‰ä½é…ç½®] (ç¯„ä¾‹æœ¬é‡‘: 100è¬)\n","   -----------------------------------\n","   ğŸŸ  æ¯”ç‰¹å¹£ (BTC) : {target_pct*100:>5.1f}%  (${btc_amount:,.0f})\n","   ğŸŸ¢ ç¾  é‡‘ (USD) : {(1-target_pct)*100:>5.1f}%  (${cash_amount:,.0f})\n","   -----------------------------------\n","\n","âš™ï¸ [æ“ä½œå‚™å¿˜éŒ„] (è«‹åš´æ ¼éµå®ˆ)\n","   1. è«‹æ¯æ—¥æ—©ä¸Š 8:00 (ç¾è‚¡æ”¶ç›¤å¾Œ) åŸ·è¡Œä¸€æ¬¡æœ¬ç¨‹å¼ã€‚\n","   2. ã€è²·å…¥è¦å‰‡ã€‘ï¼šè‹¥å»ºè­°å¾ç©ºå€‰/åŠå€‰è½‰ç‚ºæ»¿å€‰ï¼Œè«‹åˆ† 3-5 å¤©åˆ†æ‰¹è²·é€² (é˜²å‡çªç ´)ã€‚\n","   3. ã€è³£å‡ºè¦å‰‡ã€‘ï¼šè‹¥å»ºè­°å¾æŒå€‰è½‰ç‚ºç©ºå€‰ (ğŸ›‘)ï¼Œè«‹å‹¿çŒ¶è±«ï¼Œä¸€æ¬¡æœæ–·è³£å‡º (é¿éšªå„ªå…ˆ)ã€‚\n","   4. è‹¥å»ºè­°å€‰ä½èˆ‡ç›®å‰æŒå€‰å·®è· > 10%ï¼Œæ‰éœ€è¦é€²è¡Œèª¿æ•´ (çœæ‰‹çºŒè²»)ã€‚\n","=========================\n","\"\"\"\n","\n","send_line_push(message)"],"outputs":[{"output_type":"error","ename":"ModuleNotFoundError","evalue":"No module named 'stable_baselines3'","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mModuleNotFoundError\u001b[0m                       Traceback (most recent call last)","\u001b[0;32m/tmp/ipython-input-2101170728.py\u001b[0m in \u001b[0;36m<cell line: 0>\u001b[0;34m()\u001b[0m\n\u001b[1;32m     14\u001b[0m \u001b[0;32mimport\u001b[0m \u001b[0mpandas\u001b[0m \u001b[0;32mas\u001b[0m \u001b[0mpd\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     15\u001b[0m \u001b[0;32mimport\u001b[0m \u001b[0mnumpy\u001b[0m \u001b[0;32mas\u001b[0m \u001b[0mnp\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 16\u001b[0;31m \u001b[0;32mfrom\u001b[0m \u001b[0mstable_baselines3\u001b[0m \u001b[0;32mimport\u001b[0m \u001b[0mPPO\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     17\u001b[0m \u001b[0;32mimport\u001b[0m \u001b[0mgymnasium\u001b[0m \u001b[0;32mas\u001b[0m \u001b[0mgym\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     18\u001b[0m \u001b[0;32mfrom\u001b[0m \u001b[0mgymnasium\u001b[0m \u001b[0;32mimport\u001b[0m \u001b[0mspaces\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;31mModuleNotFoundError\u001b[0m: No module named 'stable_baselines3'","","\u001b[0;31m---------------------------------------------------------------------------\u001b[0;32m\nNOTE: If your import is failing due to a missing package, you can\nmanually install dependencies using either !pip or !apt.\n\nTo view examples of installing some common dependencies, click the\n\"Open Examples\" button below.\n\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n"],"errorDetails":{"actions":[{"action":"open_url","actionText":"Open Examples","url":"/notebooks/snippets/importing_libraries.ipynb"}]}}],"execution_count":1,"metadata":{"id":"6wCEcZiiiWuu","executionInfo":{"status":"error","timestamp":1765693562240,"user_tz":-480,"elapsed":3084,"user":{"displayName":"ç¿å‰æ™º","userId":"11322938985921780198"}},"outputId":"e7afea0f-81fe-4dc9-db8d-214135fb26d3","colab":{"base_uri":"https://localhost:8080/","height":395}}}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}