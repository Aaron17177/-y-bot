{"cells":[{"cell_type":"code","source":"# ==========================================\n# Gemini V37 Auto Commander (GitHub Actions ç‰ˆ) - Messaging API å‡ç´šç‰ˆ\n# ------------------------------------------\n# åŠŸèƒ½ï¼šè‡ªå‹•æŠ“å–æ•¸æ“š -> è¨“ç·´æ¨¡å‹ -> åˆ¤æ–·è¶¨å‹¢ -> ç™¼é€ LINE è¨Šæ¯\n# æ›´æ–°ï¼šå·²å¾ LINE Notify é·ç§»è‡³ LINE Messaging API\n# æ›´æ–°2ï¼šè¨Šæ¯å…§å®¹æ“´å……ï¼ŒåŒ…å«å®Œæ•´æˆ°æƒ…å®¤è³‡è¨Š\n# ==========================================\n\nimport os\nimport requests\nimport json\nimport warnings\nimport yfinance as yf\nimport pandas as pd\nimport numpy as np\nfrom stable_baselines3 import PPO\nimport gymnasium as gym\nfrom gymnasium import spaces\n\nwarnings.filterwarnings(\"ignore\")\n\n# å¾ç’°å¢ƒè®Šæ•¸è®€å– LINE Messaging API è¨­å®š\nLINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')\nLINE_USER_ID = os.environ.get('LINE_USER_ID')\n\ndef send_line_push(msg):\n    if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_USER_ID:\n        print(\"âŒ æœªè¨­å®š LINE_CHANNEL_ACCESS_TOKEN æˆ– LINE_USER_IDï¼Œç„¡æ³•ç™¼é€é€šçŸ¥\")\n        print(\"--- è¨Šæ¯å…§å®¹ ---\")\n        print(msg)\n        return\n    \n    url = 'https://api.line.me/v2/bot/message/push'\n    headers = {\n        'Content-Type': 'application/json',\n        'Authorization': f'Bearer {LINE_CHANNEL_ACCESS_TOKEN}'\n    }\n    \n    # Messaging API çš„ Payload æ ¼å¼\n    payload = {\n        \"to\": LINE_USER_ID,\n        \"messages\": [\n            {\n                \"type\": \"text\",\n                \"text\": msg\n            }\n        ]\n    }\n    \n    try:\n        response = requests.post(url, headers=headers, json=payload)\n        if response.status_code == 200:\n            print(\"âœ… Line è¨Šæ¯ç™¼é€æˆåŠŸ\")\n        else:\n            print(f\"âŒ Line ç™¼é€å¤±æ•—: {response.status_code}\")\n            print(response.text)\n    except Exception as e:\n        print(f\"âŒ é€£ç·šéŒ¯èª¤: {e}\")\n\n# ==========================================\n# 1. æ•¸æ“šç²å–èˆ‡ç‰¹å¾µå·¥ç¨‹\n# ==========================================\nprint(\"æ­£åœ¨é€£ç·šæ•¸æ“šåº«...\")\nSTART_DATE = '2015-01-01'\ntickers = ['BTC-USD', '^VIX']\nraw_data = yf.download(tickers, start=START_DATE, group_by='ticker', progress=False)\n\ndf = pd.DataFrame()\ntry:\n    if 'BTC-USD' in raw_data.columns:\n        df['Close'] = raw_data['BTC-USD']['Close']\n    elif 'Close' in raw_data.columns:\n        df['Close'] = raw_data['Close']\n    \n    if '^VIX' in raw_data.columns:\n        df['VIX'] = raw_data['^VIX']['Close']\n    else:\n        df['VIX'] = 20.0\nexcept KeyError:\n    df['Close'] = raw_data.iloc[:, 0]\n    df['VIX'] = 20.0\n\ndf.ffill(inplace=True)\ndf.dropna(inplace=True)\n\n# æŒ‡æ¨™è¨ˆç®—\ndf['SMA_140'] = df['Close'].rolling(window=140).mean()\ndf['Dist_Trend'] = (df['Close'] - df['SMA_140']) / df['SMA_140']\ndf['SMA_200'] = df['Close'].rolling(window=200).mean()\ndf['Mayer'] = df['Close'] / df['SMA_200']\ndf['VIX_Level'] = df['VIX'] / 30.0\n\ndef calculate_rsi(series, period=14):\n    delta = series.diff()\n    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()\n    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()\n    rs = gain / loss\n    return 100 - (100 / (1 + rs))\ndf['RSI'] = calculate_rsi(df['Close'])\n\ndf.dropna(inplace=True)\ntrain_df = df.copy()\n\n# ==========================================\n# 2. AI ç’°å¢ƒ\n# ==========================================\nclass GeminiFinalEnv(gym.Env):\n    def __init__(self, dataframe):\n        super(GeminiFinalEnv, self).__init__()\n        self.df = dataframe\n        self.current_step = 0\n        self.action_space = spaces.Discrete(3) \n        self.observation_space = spaces.Box(low=-np.inf, high=np.inf, shape=(5,), dtype=np.float32)\n        self.holdings = 0.0 \n\n    def reset(self, seed=None, options=None):\n        super().reset(seed=seed)\n        self.current_step = 0\n        self.holdings = 0.0\n        return self._next_observation(), {}\n    \n    def _next_observation(self):\n        obs = np.array([\n            self.df['Dist_Trend'].iloc[self.current_step],\n            self.df['Mayer'].iloc[self.current_step] / 3.0,\n            self.df['VIX_Level'].iloc[self.current_step],\n            self.df['RSI'].iloc[self.current_step] / 100,\n            float(self.holdings)\n        ], dtype=np.float32)\n        return np.nan_to_num(obs)\n\n    def step(self, action):\n        self.current_step += 1\n        target_pct = {0: 0.0, 1: 0.5, 2: 1.0}[int(action)]\n        \n        # é¢¨æ§é‚è¼¯\n        if self.df['Mayer'].iloc[self.current_step] > 2.4:\n            target_pct = min(target_pct, 0.5)\n        if self.df['Dist_Trend'].iloc[self.current_step] < 0:\n            if self.df['RSI'].iloc[self.current_step] > 30: \n                target_pct = 0.0\n        if self.df['VIX_Level'].iloc[self.current_step] > 1.0:\n            target_pct = 0.0\n\n        btc_ret = self.df['Close'].iloc[self.current_step] / self.df['Close'].iloc[self.current_step-1] - 1\n        reward = target_pct * btc_ret * 100\n        if self.df['Dist_Trend'].iloc[self.current_step] > 0 and target_pct == 1.0:\n            reward += 0.01\n            \n        done = self.current_step >= len(self.df) - 2\n        return self._next_observation(), reward, done, False, {}\n\n# ==========================================\n# 3. è¨“ç·´èˆ‡é æ¸¬\n# ==========================================\nprint(\"AI æ­£åœ¨åˆ†ææ­·å²æ•¸æ“š...\")\nenv_train = GeminiFinalEnv(train_df)\nmodel = PPO(\"MlpPolicy\", env_train, verbose=0, learning_rate=0.0003, ent_coef=0.01)\n# ç‚ºäº†ç¯€çœ GitHub è³‡æºï¼Œæ¯æ—¥åŸ·è¡Œè¨“ç·´æ­¥æ•¸å¯ç¨å¾®é™ä½ï¼Œå› ç‚ºæ¨¡å‹çµæ§‹ç°¡å–®\nmodel.learn(total_timesteps=30000)\n\n# ç”Ÿæˆä»Šæ—¥è¨Šè™Ÿ\nenv_live = GeminiFinalEnv(train_df)\nobs, _ = env_live.reset()\nfor _ in range(len(train_df) - 1):\n    action, _ = model.predict(obs)\n    env_live.step(action)\n    obs = env_live._next_observation()\n\nraw_action, _ = model.predict(obs)\nraw_action = int(raw_action)\n\n# ==========================================\n# 4. ç”Ÿæˆ Line å ±å‘Š\n# ==========================================\nlatest_data = df.iloc[-1]\nlatest_date = df.index[-1].strftime('%Y-%m-%d')\nlatest_price = latest_data['Close']\nsma140 = latest_data['SMA_140']\nmayer = latest_data['Mayer']\nvix = latest_data['VIX']\nrsi = latest_data['RSI']\n\ntarget_pct = {0: 0.0, 1: 0.5, 2: 1.0}[raw_action]\nstatus_icon = \"âšª\"\nshort_msg = \"\"\nlong_reason = \"\" # æ–°å¢è©³ç´°ç†ç”±\n\n# é¢¨æ§é‡ç¾\nis_bull = latest_data['Dist_Trend'] > 0\nis_overheated = latest_data['Mayer'] > 2.4\nis_oversold = latest_data['RSI'] < 30\nis_panic = latest_data['VIX'] > 30\n\nif is_panic:\n    target_pct = 0.0\n    status_icon = \"ğŸŒªï¸\"\n    short_msg = \"ææ…Œé¿éšª (Cash Only)\"\n    long_reason = \"VIX æŒ‡æ•¸éé«˜ (>30)ï¼Œå¸‚å ´æ¥µåº¦ä¸ç©©ï¼Œå¼·åˆ¶ç©ºå€‰ä¿å‘½ã€‚\"\nelif is_overheated:\n    target_pct = min(target_pct, 0.5)\n    status_icon = \"âš ï¸\"\n    short_msg = \"éç†±æ¸›ç¢¼ (Max 50%)\"\n    long_reason = \"Mayer å€æ•¸ > 2.4ï¼Œåƒ¹æ ¼åš´é‡åé›¢å‡ç·šï¼Œå¼·åˆ¶æ¸›ç¢¼é–å®šåˆ©æ½¤ã€‚\"\nelif not is_bull:\n    if is_oversold:\n        status_icon = \"âš¡\"\n        short_msg = \"ç†Šå¸‚æ¶åå½ˆ (High Risk)\"\n        long_reason = \"é›–ç„¶è™•æ–¼ç†Šå¸‚ (åƒ¹æ ¼ < 140æ—¥ç·š)ï¼Œä½† RSI è¶…è³£ï¼Œå˜—è©¦æ¶çŸ­ (é«˜é¢¨éšª)ã€‚\"\n    else:\n        target_pct = 0.0\n        status_icon = \"ğŸ›‘\"\n        short_msg = \"ç©ºå€‰è§€æœ› (Trend Off)\"\n        long_reason = \"ã€ç†Šå¸‚é˜²ç¦¦ã€‘åƒ¹æ ¼è·Œç ´ 140æ—¥ç”Ÿå‘½ç·šï¼Œä¸”ç„¡è¶…è³£è¨Šè™Ÿï¼Œå¼·åˆ¶ç©ºå€‰ç­‰å¾…è¶¨å‹¢å›ç©©ã€‚\"\nelse:\n    if raw_action == 2:\n        status_icon = \"ğŸš€\"\n        short_msg = \"æ»¿å€‰é€²æ”» (Full BTC)\"\n        long_reason = \"ã€é †å‹¢é€²æ”»ã€‘åƒ¹æ ¼ç«™ç©© 140æ—¥ç·šï¼Œä¼°å€¼åˆç†ï¼Œå‹•èƒ½å¼·å‹ã€‚å»ºè­°æ»¿å€‰æŒæœ‰ã€‚\"\n    elif raw_action == 1:\n        status_icon = \"âš–ï¸\"\n        short_msg = \"åŠå€‰éœ‡ç›ª (50% BTC)\"\n        long_reason = \"ã€éœ‡ç›ªæŒæœ‰ã€‘è¶¨å‹¢å‘ä¸Šä½†å‹•èƒ½æ¸›å¼±ï¼Œå»ºè­°åŠå€‰æŒæœ‰ï¼Œé€²å¯æ”»é€€å¯å®ˆã€‚\"\n    else:\n        status_icon = \"ğŸ›¡ï¸\"\n        short_msg = \"ä¿å®ˆè§€æœ›\"\n        long_reason = \"ã€ä¿å®ˆè§€æœ›ã€‘è¶¨å‹¢é›–å‘ä¸Šï¼Œä½† AI åµæ¸¬åˆ°æ½›åœ¨é¢¨éšªï¼Œé¸æ“‡æš«æ™‚ç©ºå€‰ã€‚\"\n\n# è¨ˆç®—å»ºè­°é‡‘é¡ (ç¯„ä¾‹æœ¬é‡‘: 100è¬)\nbase_capital = 1000000 \nbtc_amount = base_capital * target_pct\ncash_amount = base_capital * (1 - target_pct)\n\n# çµ„åˆå®Œæ•´è¨Šæ¯ (Rich Message)\nmessage = f\"\"\"\n=========================\nğŸ† Gemini V37 å¯¦æˆ°æˆ°æƒ…å®¤\nğŸ“… æ•¸æ“šæ—¥æœŸ: {latest_date}\n=========================\n\nğŸ“Š [å¸‚å ´å¥åº·åº¦é«”æª¢]\n   ğŸ’° BTC åƒ¹æ ¼ : ${latest_price:,.2f}\n   ğŸ“ˆ è¶¨å‹¢ç·š (140MA): ${sma140:,.2f}   {'âœ… å¤šé ­' if is_bull else 'âŒ ç©ºé ­'}\n   ğŸŒ¡ï¸ ä¼°å€¼ (Mayer): {mayer:.2f}        {'ğŸ”¥ éç†±' if is_overheated else 'â„ï¸ åˆç†'}\n   ğŸŒŠ ææ…Œ (VIX)  : {vix:.2f}        {'ğŸŒªï¸ ææ…Œ' if is_panic else 'ğŸ˜Œ ç©©å®š'}\n   âš¡ å‹•èƒ½ (RSI)  : {rsi:.2f}\n\nğŸ“¢ [AI æŒ‡æ®å®˜æŒ‡ä»¤]\n   {status_icon} {long_reason}\n\nğŸ’¼ [å»ºè­°å€‰ä½é…ç½®] (ç¯„ä¾‹æœ¬é‡‘: 100è¬)\n   -----------------------------------\n   ğŸŸ  æ¯”ç‰¹å¹£ (BTC) : {target_pct*100:>5.1f}%  (${btc_amount:,.0f})\n   ğŸŸ¢ ç¾  é‡‘ (USD) : {(1-target_pct)*100:>5.1f}%  (${cash_amount:,.0f})\n   -----------------------------------\n\nâš™ï¸ [æ“ä½œå‚™å¿˜éŒ„] (è«‹åš´æ ¼éµå®ˆ)\n   1. è«‹æ¯æ—¥æ—©ä¸Š 8:00 (ç¾è‚¡æ”¶ç›¤å¾Œ) åŸ·è¡Œä¸€æ¬¡æœ¬ç¨‹å¼ã€‚\n   2. ã€è²·å…¥è¦å‰‡ã€‘ï¼šè‹¥å»ºè­°å¾ç©ºå€‰/åŠå€‰è½‰ç‚ºæ»¿å€‰ï¼Œè«‹åˆ† 3-5 å¤©åˆ†æ‰¹è²·é€² (é˜²å‡çªç ´)ã€‚\n   3. ã€è³£å‡ºè¦å‰‡ã€‘ï¼šè‹¥å»ºè­°å¾æŒå€‰è½‰ç‚ºç©ºå€‰ (ğŸ›‘)ï¼Œè«‹å‹¿çŒ¶è±«ï¼Œä¸€æ¬¡æœæ–·è³£å‡º (é¿éšªå„ªå…ˆ)ã€‚\n   4. è‹¥å»ºè­°å€‰ä½èˆ‡ç›®å‰æŒå€‰å·®è· > 10%ï¼Œæ‰éœ€è¦é€²è¡Œèª¿æ•´ (çœæ‰‹çºŒè²»)ã€‚\n=========================\n\"\"\"\n\nsend_line_push(message)","outputs":[],"execution_count":null,"metadata":{}}],"metadata":{"colab":{"from_bard":true},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}