# ==========================================
# Gemini V44 Super Nova (SN-Sentinel): Retirement Commander v8.8.3
# ------------------------------------------
# [ç¢ºç«‹é‚è¼¯ï¼šé€€ä¼‘æ”¶ç§Ÿçµ‚æ¥µå¯¦æˆ°ç‰ˆ]
# 1. ç”Ÿæ´»è²»è‡ªå‹•åŠ è–ª: æ¯å¹´ 1/1 è‡ªå‹•èª¿å‡ 10% ææ¬¾åŸºæº– (è¤‡åˆ©)ã€‚
# 2. å‹•æ…‹ 3 å€å¸³ç¯·: æ ¹æ“šç›®å‰è–ªè³‡æ°´æº–ï¼Œè‡ªå‹•è¨ˆç®—æ‡‰å„²å‚™çš„ 3 å¹´ç”Ÿæ´»ç·©è¡é‡‘ã€‚
# 3. æ ¸å¿ƒ 50/30 é–å®š: ä¾å¼·å¼±è‡ªå‹•åˆ‡æ›ï¼Œä¸”é€²æ”»æ™‚ ETH ä¸Šé™é–æ­» 30%ã€‚
# 4. æ¸›é€Ÿææ¬¾ä¿è­·: è³‡ç”¢ä½æ–¼ 3000 è¬æ™‚ï¼Œå»ºè­°ç™¼è–ªæ‰“ 8 æŠ˜ã€‚
# 5. LINE æ¨æ’­ç³»çµ±: æ•´åˆ Messaging APIï¼Œæ¯æ—¥ç™¼é€é€€ä¼‘æˆ°å ±èˆ‡æ“ä½œæŒ‡ä»¤ã€‚
# ==========================================

import os
import sys
import requests
import warnings
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

warnings.filterwarnings("ignore")

# ==========================================
# 0. LINE è¨­å®š (Messaging API)
# ==========================================
# è«‹åœ¨ GitHub Settings -> Secrets ä¸­è¨­å®šä»¥ä¸‹è®Šæ•¸ï¼Œæˆ–å¡«å…¥æœ¬åœ°æ¸¬è©¦é‡‘é‘°
LINE_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_UID = os.environ.get('LINE_USER_ID')

def send_line_push(msg):
    if not LINE_TOKEN or not LINE_UID:
        print("âš ï¸ æœªæª¢æ¸¬åˆ° LINE é‡‘é‘°ï¼Œåƒ…åœ¨çµ‚ç«¯æ©Ÿè¼¸å‡ºï¼š")
        print(msg)
        return
    
    url = 'https://api.line.me/v2/bot/message/push'
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {LINE_TOKEN}'
    }
    payload = {
        "to": LINE_UID,
        "messages": [{"type": "text", "text": msg}]
    }
    try:
        res = requests.post(url, headers=headers, json=payload)
        if res.status_code == 200:
            print("âœ… LINE é€€ä¼‘æˆ°å ±ç™¼é€æˆåŠŸï¼")
        else:
            print(f"âŒ LINE ç™¼é€å¤±æ•—: {res.text}")
    except Exception as e:
        print(f"âŒ LINE ç¶²çµ¡éŒ¯èª¤: {e}")

# è‡ªå‹•å®‰è£ yfinance
try:
    import yfinance as yf
except ImportError:
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
    import yfinance as yf

# ==========================================
# âš™ï¸ æ¯æ—¥é€€ä¼‘å¯¦æˆ°å¸³æˆ¶ç¾æ³ (ä¸‹å–®å‰è«‹åœ¨æ­¤æ›´æ–°æ•¸æ“š)
# ==========================================
USER_ACCOUNT = {
    'BANK_CASH_TWD': 6000000.0,      # ğŸ‘ˆ 1. ç›®å‰éŠ€è¡Œ/ç¾å‚µå¸³ç¯·é¤˜é¡ (TWD)
    'CRYPTO_EQUITY_USDT': 750000.0,  # ğŸ‘ˆ 2. å¹£åœˆç›®å‰ç¸½è³‡ç”¢ (æŠ˜åˆ USDT)
    
    'INITIAL_ANNUAL_PAY': 2000000.0, # é€€ä¼‘ç¬¬ä¸€å¹´çš„ç¸½å¹´è–ª (200è¬)
    'RETIRE_YEAR': 2025,             # é€€ä¼‘èµ·å§‹å¹´ä»½
    'SALARY_GROWTH': 0.10,           # æ¯å¹´å›ºå®šåŠ è–ª 10%
    
    # --- ç›®å‰æŒå€‰ä½”æ¯” (äº¤æ˜“æ‰€ App çœ‹åˆ°çš„æ•¸æ“šï¼Œå¡«å…¥ 0.0 ~ 1.0) ---
    'CURRENT_BTC_W': 0.0,           
    'CURRENT_ETH_W': 0.0,           
    'CURRENT_SAT_1_SYM': 'NONE',    
    'CURRENT_SAT_1_W': 0.0,
    'CURRENT_SAT_2_SYM': 'NONE',    
    'CURRENT_SAT_2_W': 0.0
}

# ç­–ç•¥å¸¸æ•¸
USD_TWD_RATE = 32.0
REBALANCE_THRESHOLD = 0.05  # 5% èª¿å€‰é–€æª» (v8.8.3 åŸºæº–)
SAFE_BARRIER_TWD = 30000000.0
PENDLE_APY = 0.10           # é€€ä¼‘æœŸé–’ç½®è³‡é‡‘é ˜ Pendle APY

# è¡›æ˜Ÿå€™é¸æ±  (Lean 15 å…¨æ˜æ˜Ÿ)
SATELLITE_POOL = {
    'L1': ['SOL-USD', 'AVAX-USD', 'BNB-USD', 'SUI-USD', 'ADA-USD'],
    'MEME': ['DOGE-USD', 'SHIB-USD', 'PEPE24478-USD'],
    'AI_DEFI': ['RENDER-USD', 'INJ-USD'],
    'LEGACY': ['TRX-USD', 'XLM-USD', 'BCH-USD', 'LTC-USD', 'ZEC-USD']
}

# ==========================================
# 1. ç­–ç•¥åˆ†æå¼•æ“ (Master v8.8.3 Logic)
# ==========================================
def analyze_retirement_v8_8_3():
    all_sats = [t for sub in SATELLITE_POOL.values() for t in sub]
    tickers = ['BTC-USD', 'ETH-USD', '^VIX'] + all_sats
    
    # æŠ“å–æœ€è¿‘ä¸€å¹´çš„æ•¸æ“šä»¥ç¢ºä¿ SMA 140 ç©©å®š
    data = yf.download(tickers, start=(datetime.now() - timedelta(days=365)).strftime('%Y-%m-%d'), group_by='ticker', progress=False, auto_adjust=True)
    
    data_map = {}
    ticker_to_sector = {t.split('-')[0]: s for s, ts in SATELLITE_POOL.items() for t in ts}
    ticker_to_sector['PEPE24478'] = 'MEME'

    for ticker in data.columns.levels[0]:
        symbol = ticker.split('-')[0] if ticker != '^VIX' else 'VIX'
        df = data[ticker].copy().ffill()
        if df.empty or len(df) < 140: continue
        df['SMA_60'] = df['Close'].rolling(60).mean()
        df['SMA_140'] = df['Close'].rolling(140).mean()
        df['Ret_20'] = df['Close'].pct_change(20)
        data_map[symbol] = df

    today = data_map['BTC'].index[-1]
    vix = data_map['VIX'].loc[today]['Close']
    row_btc = data_map['BTC'].loc[today]
    row_eth = data_map['ETH'].loc[today]
    bull_btc = row_btc['Close'] > row_btc['SMA_140']
    
    # è¡›æ˜Ÿé¸å¹£ (RS å‹•èƒ½æ’å)
    candidates = []
    for sym, sector in ticker_to_sector.items():
        if sym not in data_map: continue
        r = data_map[sym].loc[today]
        if r['Close'] > r['SMA_60'] and r['Ret_20'] > row_btc['Ret_20']:
            candidates.append({'sym': sym, 'score': r['Ret_20'], 'sector': sector})
    
    candidates.sort(key=lambda x: x['score'], reverse=True)
    top_targets = []
    if candidates:
        top_targets.append(candidates[0])
        if len(candidates) > 1:
            f_sec = candidates[0]['sector']
            challenger = sorted([{**c, 'adj': c['score']*0.8 if c['sector']==f_sec else c['score']} for c in candidates[1:]], key=lambda x: x['adj'], reverse=True)
            top_targets.append(challenger[0])

    # è¨ˆç®—åˆ†é… (æ ¸å¿ƒ 90 / è¡›æ˜Ÿ 10)
    tw = {'BTC': 0.0, 'ETH': 0.0, 'SAT1': 0.0, 'SAT2': 0.0}
    ss = {'SAT1': 'NONE', 'SAT2': 'NONE'}

    if vix < 30 and bull_btc:
        sat_alloc = 0.10
        # Sentinel æ ¸å¿ƒåŒ¯ç‡å“¨å…µ (50/30é€²æ”» æˆ– 70/20é˜²ç¦¦)
        if row_eth['Ret_20'] > row_btc['Ret_20'] and row_eth['Close'] > row_eth['SMA_140']:
            tw['BTC'], tw['ETH'] = 0.50, 0.30 # é€²æ”»ä¸Šé™é–å®š
        else:
            tw['BTC'], tw['ETH'] = 0.70, 0.20 # é˜²ç¦¦å‹
            
        for i, t in enumerate(top_targets):
            key = f'SAT{i+1}'
            tw[key] = sat_alloc / 2
            ss[key] = t['sym']

    return tw, ss, vix, bull_btc, today, data_map

# ==========================================
# 2. æˆ°å ±ç”Ÿæˆèˆ‡æœƒè¨ˆå¯©è¨ˆ
# ==========================================
def generate_report():
    tw, ss, vix, is_bull, dt, d_map = analyze_retirement_v8_8_3()
    
    # --- é€€ä¼‘æœƒè¨ˆè¨ˆç®— ---
    years_passed = max(0, dt.year - USER_ACCOUNT['RETIRE_YEAR'])
    curr_annual_pay = USER_ACCOUNT['INITIAL_ANNUAL_PAY'] * (1 + USER_ACCOUNT['SALARY_GROWTH']) ** years_passed
    curr_monthly_pay = curr_annual_pay / 12
    
    tent_twd = USER_ACCOUNT['BANK_CASH_TWD']
    crypto_twd = USER_ACCOUNT['CRYPTO_EQUITY_USDT'] * USD_TWD_RATE
    total_assets_twd = tent_twd + crypto_twd
    
    ideal_tent = curr_annual_pay * 3
    tent_health = (tent_twd / ideal_tent) * 100
    
    is_slow_mode = total_assets_twd < SAFE_BARRIER_TWD
    final_pay_advice = curr_monthly_pay if not is_slow_mode else curr_monthly_pay * 0.8

    # --- è¨Šæ¯æ§‹å»º ---
    msg = f"ğŸ° V44 é€€ä¼‘æŒ‡æ®å®˜æˆ°å ± (v8.8.3)\n"
    msg += f"ğŸ“… æ—¥æœŸ: {dt.strftime('%Y-%m-%d')}\n"
    msg += f"ğŸ’° ç¸½è³‡ç”¢: ${total_assets_twd/10000:,.1f} è¬ TWD\n"
    msg += f"ğŸŒ ç’°å¢ƒ: {'ğŸŸ¢é€²æ”»' if is_bull else 'ğŸ›¡ï¸é¿éšª'} (VIX {vix:.1f})\n"
    msg += "----------------------------\n"

    # ç”Ÿæ´»è²»èˆ‡å¸³ç¯·
    msg += f"ğŸ“Š [é€€ä¼‘å®‰å…¨å¯©è¨ˆ]\n"
    msg += f"â€¢ æœ¬æœˆæ‡‰é ˜æœˆè–ª: ${final_pay_advice:,.0f} TWD" + (" (ğŸš¨å·²æ¸›é€Ÿ)" if is_slow_mode else "") + "\n"
    msg += f"â€¢ ç¾é‡‘å¸³ç¯·æ°´ä½: ${tent_twd/10000:,.1f} è¬\n"
    msg += f"â€¢ å¸³ç¯·å¥åº·åº¦: {tent_health:.1f}%\n"
    
    if tent_health < 100 and not is_slow_mode:
        msg += f"ğŸ‘‰ å»ºè­°å›å¡«å¸³ç¯·: ${ (ideal_tent - tent_twd):,.0f} TWD\n"
    msg += "----------------------------\n"

    # äº¤æ˜“æŒ‡ä»¤
    msg += f"ğŸ“ [å¯¦æˆ°äº¤æ˜“æŒ‡ä»¤]\n"
    assets = [
        ('BTC', USER_ACCOUNT['CURRENT_BTC_W'], tw['BTC'], "NONE"),
        ('ETH', USER_ACCOUNT['CURRENT_ETH_W'], tw['ETH'], "NONE"),
        (f"è¡›æ˜Ÿ1:{ss['SAT1']}", USER_ACCOUNT['CURRENT_SAT_1_W'], tw['SAT1'], USER_ACCOUNT['CURRENT_SAT_1_SYMBOL']),
        (f"è¡›æ˜Ÿ2:{ss['SAT2']}", USER_ACCOUNT['CURRENT_SAT_2_W'], tw['SAT2'], USER_ACCOUNT['CURRENT_SAT_2_SYMBOL'])
    ]

    for name, curr, target, held_sym in assets:
        diff = target - curr
        action = "âœ…çºŒæŠ±"
        if target == 0 and curr > 0.01: action = "ğŸš¨ç«‹å³æ¸…å€‰"
        elif "è¡›æ˜Ÿ" in name:
            target_sym = name.split(':')[1]
            if target_sym != "NONE" and target_sym != held_sym: action = f"ğŸ”„æ›è‡³ {target_sym}"
            elif abs(diff) > REBALANCE_THRESHOLD: action = "ğŸ””å»ºè­°èª¿å€‰"
        elif abs(diff) > REBALANCE_THRESHOLD: action = "ğŸ””å»ºè­°èª¿å€‰"
        
        msg += f"â€¢ {name}: {action} ({target*100:.1f}%)\n"

    msg += "----------------------------\n"
    # ææ¬¾æŒ‡å¼•
    if is_bull:
        msg += f"ğŸŸ¢ [ç™¼è–ªæŒ‡å¼•] æœ¬æœˆè«‹ã€Œç›´æ¥è³£å¹£ã€æé ˜ ${final_pay_advice:,.0f} TWDã€‚\n"
    else:
        msg += f"ğŸ›¡ï¸ [ç™¼è–ªæŒ‡å¼•] æœ¬æœˆè«‹ä½¿ç”¨ã€Œç¾é‡‘/åˆ©æ¯ã€æé ˜ ${final_pay_advice:,.0f} TWDã€‚\n"
    
    msg += f"\nğŸ’¡ æŒ‡æ®å®˜æé†’: 5% é–€æª»è­·èˆªä¸­ã€‚è³‡ç”¢ç›®å‰é ˜å…ˆæœ¬é‡‘ {(total_assets_twd/SAFE_BARRIER_TWD - 1)*100:.1f}%ï¼Œç´€å¾‹åŸ·è¡Œï¼Œäº«å—ç”Ÿæ´»ã€‚"
    
    return msg

# ==========================================
# ä¸»ç¨‹å¼å…¥å£
# ==========================================
if __name__ == "__main__":
    try:
        report = generate_report()
        # print(report) # æœ¬åœ°æ¸¬è©¦æ™‚å¯é–‹å•Ÿ
        send_line_push(report)
    except Exception as e:
        err_msg = f"âŒ é€€ä¼‘æŒ‡æ®å®˜åŸ·è¡ŒéŒ¯èª¤: {str(e)}"
        print(err_msg)
        send_line_push(err_msg)
