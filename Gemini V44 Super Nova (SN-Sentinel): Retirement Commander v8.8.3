# ==========================================
# Gemini V44 Super Nova (SN-Sentinel): Retirement Commander v8.9.2
# ------------------------------------------
# [ç¢ºç«‹é‚è¼¯ï¼šé‹¼éµå°ç¨± 5% é–€æª» + è²¡å‹™å¤©èŠ±æ¿]
# 1. æ ¸å¿ƒ (90%): å‹•æ…‹å“¨å…µï¼Œé€²æ”»é–å®š 50/30 (ETHä¸Šé™30%)ï¼Œé˜²ç¦¦ 70/20ã€‚
# 2. è¡›æ˜Ÿ (10%): Lean 15 é›™æ˜Ÿè¼ªå‹• (5% + 5%)ï¼Œç´”å‹•èƒ½é¸å¹£ã€‚
# 3. é‹¼éµè£ç”²: å°ç¨± 5% èª¿å€‰é–€æª»ï¼Œè²·è³£çš†åŒï¼Œæ¥µå°åŒ–æ‰‹çºŒè²»ç£¨æã€‚
# 4. è²¡å‹™è¦å‰‡: æ¯å¹´åŠ è–ª 10%ï¼Œæœˆè–ª 30 è¬å°é ‚ (ç ´å„„è§£é–)ï¼Œ3 å€å‹•æ…‹å¸³ç¯·ã€‚
# 5. æŒ‡ä»¤é€šçŸ¥: æ•´åˆ LINE Messaging API æ¯æ—¥æ¨æ’­å¯¦æˆ°æˆ°å ±ã€‚
# ==========================================

import os
import sys
import requests
import warnings
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

warnings.filterwarnings("ignore")

# ==========================================
# 0. LINE å‚³é€æ¨¡çµ„ (Messaging API)
# ==========================================
LINE_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_UID = os.environ.get('LINE_USER_ID')

def send_line_push(msg):
    if not LINE_TOKEN or not LINE_UID:
        print("âš ï¸ æœªæª¢æ¸¬åˆ° LINE é‡‘é‘°ï¼Œåƒ…åœ¨çµ‚ç«¯æ©Ÿè¼¸å‡ºï¼š")
        print(msg); return
    url = 'https://api.line.me/v2/bot/message/push'
    headers = {'Content-Type': 'application/json', 'Authorization': f'Bearer {LINE_TOKEN}'}
    payload = {"to": LINE_UID, "messages": [{"type": "text", "text": msg}]}
    try:
        res = requests.post(url, headers=headers, json=payload)
        if res.status_code == 200: print("âœ… LINE è¨Šæ¯æ¨æ’­æˆåŠŸï¼")
    except: print("âŒ ç¶²çµ¡éŒ¯èª¤")

try:
    import yfinance as yf
except ImportError:
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
    import yfinance as yf

# ==========================================
# âš™ï¸ æ¯æ—¥é€€ä¼‘å¸³æˆ¶ç¾æ³ (è«‹æ¯æ—¥åœ¨æ­¤æ›´æ–°æ•¸æ“š)
# ==========================================
USER_ACCOUNT = {
    'BANK_CASH_TWD': 6000000.0,      # ğŸ‘ˆ 1. ç›®å‰éŠ€è¡Œ/ç¾å‚µå¸³ç¯·é¤˜é¡ (TWD)
    'CRYPTO_EQUITY_USDT': 100000.0,  # ğŸ‘ˆ 2. å¹£åœˆç›®å‰ç¸½è³‡ç”¢ (æŠ˜åˆ USDT)
    
    'INITIAL_MONTHLY_PAY': 166666.0, # é€€ä¼‘ç¬¬ä¸€å¹´çš„æœˆè–ªåŸºæ•¸
    'RETIRE_YEAR': 2025,             # é€€ä¼‘èµ·å§‹å¹´ä»½
    'SALARY_GROWTH': 0.10,           # æ¯å¹´åŠ è–ªå¹…åº¦
    'SALARY_CAP': 300000.0,          # ğŸ‘ˆ 30 è¬æœˆè–ªå¤©èŠ±æ¿
    'UNLOCK_BARRIER': 100000000.0,   # ğŸ‘ˆ 1 å„„è³‡ç”¢è§£é–åŠ è–ª
    
    # --- ç›®å‰æŒå€‰ä½”æ¯” (äº¤æ˜“æ‰€ App çœ‹åˆ°çš„æ•¸æ“šï¼Œ0.0 ~ 1.0) ---
    'CURRENT_BTC_W': 0.0,           
    'CURRENT_ETH_W': 0.0,           
    'CURRENT_SAT_1_SYM': 'NONE',    
    'CURRENT_SAT_1_W': 0.0,
    'CURRENT_SAT_2_SYM': 'NONE',    
    'CURRENT_SAT_2_W': 0.0
}

# --- çµ‚æ¥µåŸºæº–åƒæ•¸ ---
REBALANCE_THRESHOLD = 0.05  # ğŸ‘ˆ é‹¼éµå°ç¨± 5% é–€æª»
USD_TWD_RATE = 32.0
SAFE_BARRIER_TWD = 30000000.0

# ã€Lean 15 è¡›æ˜Ÿæ± ã€‘
SATELLITE_POOL = {
    'L1': ['SOL-USD', 'AVAX-USD', 'BNB-USD', 'SUI-USD', 'ADA-USD'],
    'MEME': ['DOGE-USD', 'SHIB-USD', 'PEPE24478-USD'],
    'AI_DEFI': ['RENDER-USD', 'INJ-USD'],
    'LEGACY': ['TRX-USD', 'XLM-USD', 'BCH-USD', 'LTC-USD', 'ZEC-USD']
}

# ==========================================
# 1. æ ¸å¿ƒåˆ†æå¼•æ“ (Master v8.9.2)
# ==========================================
def analyze_market_production():
    all_sats = [t for sub in SATELLITE_POOL.values() for t in sub]
    tickers = ['BTC-USD', 'ETH-USD', '^VIX'] + all_sats
    
    print(f"ğŸ“¥ æ­£åœ¨æå–å…¨çƒæ•¸æ“šä¸¦åŸ·è¡Œ 5% é–€æª»è¨ˆç®—...")
    start_str = (datetime.now() - timedelta(days=365)).strftime('%Y-%m-%d')
    data = yf.download(tickers, start=start_str, group_by='ticker', progress=False, auto_adjust=True)
    
    data_map = {}
    ticker_to_sector = {t.split('-')[0]: s for s, ts in SATELLITE_POOL.items() for t in ts}
    ticker_to_sector['PEPE24478'] = 'MEME'

    for ticker in data.columns.levels[0]:
        symbol = ticker.split('-')[0] if ticker != '^VIX' else 'VIX'
        df = data[ticker].copy().ffill()
        if df.empty or len(df) < 140: continue
        df['SMA_140'] = df['Close'].rolling(140).mean()
        df['SMA_60'] = df['Close'].rolling(60).mean()
        df['Ret_20'] = df['Close'].pct_change(20)
        data_map[symbol] = df

    today = data_map['BTC'].index[-1]
    vix = data_map['VIX'].loc[today]['Close'] if 'VIX' in data_map else 20
    row_btc = data_map['BTC'].loc[today]
    row_eth = data_map['ETH'].loc[today]
    bull_btc = row_btc['Close'] > row_btc['SMA_140']
    
    # è¡›æ˜Ÿé¸å¹£
    candidates = []
    for sym, sector in ticker_to_sector.items():
        if sym not in data_map: continue
        r = data_map[sym].loc[today]
        if r['Close'] > r['SMA_60'] and r['Ret_20'] > row_btc['Ret_20']:
            candidates.append({'sym': sym, 'score': r['Ret_20'], 'sector': sector})
    
    candidates.sort(key=lambda x: x['score'], reverse=True)
    top = []
    if candidates:
        top.append(candidates[0])
        if len(candidates) > 1:
            f_sec = candidates[0]['sector']
            challenger = sorted([{**c, 'adj': c['score']*0.8 if c['sector']==f_sec else c['score']} for c in candidates[1:]], key=lambda x: x['adj'], reverse=True)[0]
            top.append(challenger)

    # æ¬Šé‡è¨ˆç®—
    tw = {'BTC': 0.0, 'ETH': 0.0, 'SAT1': 0.0, 'SAT2': 0.0}
    ss = {'SAT1': 'NONE', 'SAT2': 'NONE'}

    if vix < 30 and bull_btc:
        sat_alloc = 0.10
        core_alloc = 0.90
        if row_eth['Ret_20'] > row_btc['Ret_20'] and row_eth['Close'] > row_eth['SMA_140']:
            # ğŸš€ é€€ä¼‘é€²æ”»æ¨¡å¼ (50/30 ä¸Šé™)
            tw['BTC'], tw['ETH'] = 0.50, 0.30
        else:
            # ğŸ›¡ï¸ é€€ä¼‘é˜²ç¦¦æ¨¡å¼
            tw['BTC'], tw['ETH'] = 0.675, 0.225
            
        for i, t in enumerate(top):
            key = f'SAT{i+1}'; tw[key] = sat_alloc / 2; ss[key] = t['sym']

    return tw, ss, vix, bull_btc, today

# ==========================================
# 2. è²¡å‹™å¯©è¨ˆèˆ‡æˆ°å ±ç”Ÿæˆ
# ==========================================
def generate_production_report():
    tw, ss, vix, is_bull, dt = analyze_market_production()
    
    # --- è¨ˆç®—é€€ä¼‘è²¡å‹™ ---
    years_passed = max(0, dt.year - USER_ACCOUNT['RETIRE_YEAR'])
    raw_salary = USER_ACCOUNT['INITIAL_MONTHLY_PAY'] * (1 + USER_ACCOUNT['SALARY_GROWTH']) ** years_passed
    
    tent_twd = USER_ACCOUNT['BANK_CASH_TWD']
    crypto_twd = USER_ACCOUNT['CRYPTO_EQUITY_USDT'] * USD_TWD_RATE
    total_assets_twd = tent_twd + crypto_twd
    
    # å¤©èŠ±æ¿æª¢æŸ¥
    is_capped = False
    if raw_salary > USER_ACCOUNT['SALARY_CAP'] and total_assets_twd < USER_ACCOUNT['UNLOCK_BARRIER']:
        final_salary = USER_ACCOUNT['SALARY_CAP']
        is_capped = True
    else:
        final_salary = raw_salary
    
    # æ¸›é€Ÿæ¨¡å¼
    is_slow = total_assets_twd < SAFE_BARRIER_TWD
    final_pay_advice = final_salary if not is_slow else final_salary * 0.8
    
    # å¸³ç¯·æ°´ä½
    ideal_tent = final_salary * 12 * 3
    tent_health = (tent_twd / ideal_tent) * 100

    # --- è¨Šæ¯æ§‹å»º ---
    msg = f"ğŸ° V44 é€€ä¼‘æŒ‡æ®å®˜ (é‹¼éµç”Ÿç”¢ç‰ˆ)\n"
    msg += f"ğŸ“… æ—¥æœŸ: {dt.strftime('%Y-%m-%d')}\n"
    msg += f"ğŸ’° ç¸½è³‡ç”¢: ${total_assets_twd/10000:,.1f} è¬ TWD\n"
    msg += f"ğŸŒ ç’°å¢ƒ: {'ğŸŸ¢é€²æ”»' if is_bull else 'ğŸ›¡ï¸é¿éšª'} (VIX {vix:.1f})\n"
    msg += "----------------------------\n"

    # å®‰å…¨å¯©è¨ˆ
    msg += f"ğŸ“Š [é€€ä¼‘å®‰å…¨å¯©è¨ˆ]\n"
    msg += f"â€¢ æœ¬æœˆæ‡‰é ˜è–ªæ°´: ${final_pay_advice:,.0f} TWD\n"
    if is_capped: msg += f"  (ğŸ”’ å·²é” 30 è¬å¤©èŠ±æ¿ï¼Œæš«åœåŠ è–ª)\n"
    if is_slow: msg += f"  (âš ï¸ è³‡ç”¢ä½æ–¼ 3000 è¬ï¼Œè–ªæ°´æ‰“ 8 æŠ˜)\n"
    msg += f"â€¢ å¸³ç¯·å¥åº·åº¦: {tent_health:.1f}%\n"
    if tent_health < 100 and total_assets_twd > SAFE_BARRIER_TWD:
        msg += f"ğŸ‘‰ å»ºè­°å‡ºé‡‘ ${ (ideal_tent - tent_twd):,.0f} è£œè¶³å¸³ç¯·\n"
    msg += "----------------------------\n"

    # äº¤æ˜“æŒ‡ä»¤
    msg += f"ğŸ“ [5% å°ç¨±é–€æª»æŒ‡ä»¤]\n"
    assets = [
        ('BTC', USER_ACCOUNT['CURRENT_BTC_W'], tw['BTC'], 'NONE'),
        ('ETH', USER_ACCOUNT['CURRENT_ETH_W'], tw['ETH'], 'NONE'),
        (f"è¡›æ˜Ÿ1:{ss['SAT1']}", USER_ACCOUNT['CURRENT_SAT_1_W'], tw['SAT1'], USER_ACCOUNT['CURRENT_SAT_1_SYM']),
        (f"è¡›æ˜Ÿ2:{ss['SAT2']}", USER_ACCOUNT['CURRENT_SAT_2_W'], tw['SAT2'], USER_ACCOUNT['CURRENT_SAT_2_SYM'])
    ]

    for name, curr, target, held_sym in assets:
        target_sym = name.split(':')[1] if ':' in name else 'NONE'
        diff = target - curr
        action = "âœ…çºŒæŠ±"
        
        if target == 0 and curr > 0.01: action = "ğŸš¨ç«‹å³æ¸…å€‰"
        elif "è¡›æ˜Ÿ" in name and target_sym != "NONE" and target_sym != held_sym:
            action = f"ğŸ”„æ›è‡³ {target_sym}"
        elif abs(diff) > REBALANCE_THRESHOLD:
            action = "ğŸ””å»ºè­°èª¿å€‰"
        
        msg += f"â€¢ {name}: {action} ({target*100:.1f}%)\n"

    msg += "----------------------------\n"
    msg += f"ğŸ’¡ æŒ‡æ®å®˜æé†’ï¼šå·²åŸ·è¡Œé‹¼éµå°ç¨±é–€æª»ã€‚é¡¯ç¤ºã€ŒçºŒæŠ±ã€æ™‚è«‹å‹¿æ“ä½œï¼Œçœä¸‹çš„æ‰‹çºŒè²»å°‡ç›´æ¥è½‰åŒ–ç‚ºæ‚¨çš„é€€ä¼‘é‡‘ã€‚"
    
    return msg

if __name__ == "__main__":
    try:
        report = generate_production_report()
        send_line_push(report)
    except Exception as e:
        err_msg = f"âŒ é€€ä¼‘æŒ‡æ®å®˜åŸ·è¡ŒéŒ¯èª¤: {str(e)}"
        print(err_msg); send_line_push(err_msg)
