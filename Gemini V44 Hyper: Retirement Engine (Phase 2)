# ==========================================
# Gemini V44 Hyper: Retirement Engine (Phase 2)
# ------------------------------------------
# é€™æ˜¯å°ˆç‚ºã€Œæ°¸çºŒæ”¶ç§ŸæœŸ (Retirement Phase)ã€è¨­è¨ˆçš„åŸ·è¡Œè…³æœ¬ã€‚
# ç›®æ¨™ï¼šä¿æœ¬ç¬¬ä¸€ï¼Œç©©å®šæä¾›ç¾é‡‘æµï¼Œä¸¦ç›£æ§ç¾é‡‘å¸³ç¯·æ°´ä½ã€‚
#
# [æ ¸å¿ƒç­–ç•¥ - é˜²å®ˆå‹]
# 1. é…ç½®èª¿æ•´: 50% BTC / 40% ETH / 10% SOL (é™ä½ SOL æ³¢å‹•)
# 2. ææ¬¾é‚è¼¯:
#    - ç‰›å¸‚: è¢«å‹•æ­¢ç›ˆ (è³£å¹£æ›ç¾é‡‘)
#    - ç†Šå¸‚: å„ªå…ˆä½¿ç”¨ Pendle åˆ©æ¯ï¼Œä¸è¶³å‰‡æ¶ˆè€—æœ¬é‡‘
# 3. ç›£æ§: ç¾é‡‘å¸³ç¯· (Cash Tent) æ°´ä½é è­¦
#
# [å¦‚ä½•ä½¿ç”¨]
# 1. ä¿®æ”¹ 'USER_CONFIG' è¼¸å…¥ç›®å‰è³‡ç”¢èˆ‡ææ¬¾éœ€æ±‚ã€‚
# 2. åŸ·è¡Œç¨‹å¼ï¼špython v44_hyper_retirement.py
# ==========================================

import sys
import subprocess
import warnings
import pandas as pd
import numpy as np
import requests
from datetime import datetime, timedelta

warnings.filterwarnings("ignore")

# è‡ªå‹•å®‰è£ä¾è³´
try:
    import yfinance as yf
except ImportError:
    print("ğŸ“¦ æ­£åœ¨å®‰è£å¿…è¦å¥—ä»¶ (yfinance)...")
    subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
    import yfinance as yf

try:
    import colorama
    from colorama import Fore, Style
    colorama.init(autoreset=True)
except ImportError:
    class Fore: RED=GREEN=YELLOW=CYAN=MAGENTA=WHITE=RESET=""
    class Style: BRIGHT=RESET=""

# ==========================================
# âš™ï¸ ç”¨æˆ¶è¨­å®š (USER_CONFIG)
# ==========================================
USER_CONFIG = {
    'CURRENT_ASSETS': 30000000,   # è¼¸å…¥ç›®å‰çš„ç¸½è³‡ç”¢ (TWD)
    'CASH_TENT_SIZE': 6000000,    # ç¾é‡‘å¸³ç¯·æ°´ä½ (TWD) - ä¿å‘½éŒ¢
    'MONTHLY_WITHDRAW': 166666,   # æ¯æœˆé è¨ˆæé ˜é‡‘é¡ (TWD)
    'PENDLE_INTEREST_RATE': 0.05, # ç›®å‰ Pendle/ç¾å‚µ å¹´åŒ–åˆ©ç‡ (5%)
    
    # [é‡è¦] LINE Token
    'LINE_TOKEN': 'æ‚¨çš„LINE_TOKEN_è²¼åœ¨é€™è£¡' 
}

# ç­–ç•¥åƒæ•¸ (é˜²å®ˆå‹é…ç½®)
STRATEGY_PARAMS = {
    'SMA_TREND': 140,
    'SMA_MAYER': 200,
    'VIX_PANIC': 30,
    'MAYER_GREED': 2.4
}

# æ¬Šé‡é…ç½® (Phase 2)
ALLOCATION = {'BTC': 0.5, 'ETH': 0.4, 'SOL': 0.1}

# ==========================================
# 1. æ•¸æ“šèˆ‡ç­–ç•¥é‚è¼¯
# ==========================================
def fetch_data():
    print(f"\n{Fore.CYAN}ğŸ“¥ æ­£åœ¨æƒæå¸‚å ´æ•¸æ“š (é€€ä¼‘æ¨¡å¼)...{Style.RESET}")
    tickers = ['BTC-USD', 'ETH-USD', 'SOL-USD', '^VIX']
    start_date = (datetime.now() - timedelta(days=400)).strftime('%Y-%m-%d')
    try:
        data = yf.download(tickers, start=start_date, group_by='ticker', progress=False)
    except Exception as e:
        print(f"{Fore.RED}âŒ æ•¸æ“šä¸‹è¼‰å¤±æ•—: {e}{Style.RESET}")
        sys.exit()
    return data

def process_data(raw_data):
    data_map = {}
    tickers_map = {'BTC': 'BTC-USD', 'ETH': 'ETH-USD', 'SOL': 'SOL-USD', 'VIX': '^VIX'}
    
    for symbol, ticker in tickers_map.items():
        df = pd.DataFrame()
        try:
            if ticker in raw_data.columns.levels[0]:
                df['Close'] = raw_data[ticker]['Close']
            elif ticker == 'BTC-USD': 
                 if 'Close' in raw_data.columns: df['Close'] = raw_data['Close']
        except: pass
            
        if df.empty: continue
        df.ffill(inplace=True)
        
        df['SMA_140'] = df['Close'].rolling(window=140).mean()
        df['SMA_200'] = df['Close'].rolling(window=200).mean()
        df['Mayer'] = df['Close'] / df['SMA_200']
        
        data_map[symbol] = df
    return data_map

def analyze_market(data_map):
    status = {}
    today = data_map['BTC'].index[-1]
    
    try: vix = data_map['VIX'].loc[today]['Close']
    except: vix = 20.0
    status['VIX'] = vix
    status['IS_PANIC'] = vix > STRATEGY_PARAMS['VIX_PANIC']
    
    # åˆ¤æ–·æ•´é«”è¶¨å‹¢ (ç”¨æ–¼ææ¬¾å»ºè­°)
    bull_count = 0
    
    for coin in ['BTC', 'ETH', 'SOL']:
        row = data_map[coin].loc[today]
        price = row['Close']
        sma = row['SMA_140']
        mayer = row['Mayer']
        
        signal = "HOLD"
        action_code = 0
        
        if status['IS_PANIC']:
            signal = "ESCAPE (Cash)"
            action_code = -1
        elif mayer > STRATEGY_PARAMS['MAYER_GREED']:
            signal = "TRIM (50%)"
            action_code = -1
            bull_count += 1
        elif price > sma:
            signal = "BUY/HOLD (100%)"
            action_code = 1
            bull_count += 1
        else:
            signal = "SELL (0%)"
            action_code = -1
            
        status[coin] = {
            'Price': price, 'SMA_140': sma, 'Mayer': mayer,
            'Signal': signal, 'Action': action_code
        }
    
    status['MARKET_STATE'] = "BULL" if bull_count >= 2 else "BEAR"
    return status, today

# ==========================================
# 2. ææ¬¾èˆ‡ç´€å¾‹å»ºè­°æ¨¡çµ„
# ==========================================
def get_withdrawal_advice(status):
    monthly = USER_CONFIG['MONTHLY_WITHDRAW']
    tent = USER_CONFIG['CASH_TENT_SIZE']
    assets = USER_CONFIG['CURRENT_ASSETS']
    
    # è¨ˆç®—é ä¼°åˆ©æ¯æ”¶å…¥ (è‹¥å…¨ç¾é‡‘)
    yearly_interest = assets * 0.8 * USER_CONFIG['PENDLE_INTEREST_RATE'] 
    interest_coverage = (yearly_interest / (monthly * 12)) * 100
    
    advice = ""
    source = ""
    
    if status['MARKET_STATE'] == "BULL":
        advice = f"ğŸŸ¢ [ç‰›å¸‚ææ¬¾å»ºè­°]\n"
        advice += f"æœ¬æœˆè«‹ç›´æ¥ã€Œè³£å¹£ã€æé ˜ ${monthly:,.0f}ã€‚\n"
        advice += "é€™å±¬æ–¼è¢«å‹•æ­¢ç›ˆï¼Œåœ¨è³‡ç”¢å¢å€¼æ™‚ä¿®å‰ªæ¨¹æã€‚"
        source = "ä¾†æº: äº¤æ˜“æ‰€è³£å¹£"
    else:
        advice = f"ğŸ”´ [ç†Šå¸‚/ç©ºå€‰ææ¬¾å»ºè­°]\n"
        advice += f"æœ¬æœˆè«‹ä½¿ç”¨ã€ŒPendle åˆ©æ¯ã€æé ˜ ${monthly:,.0f}ã€‚\n"
        advice += f"è‹¥åˆ©æ¯ä¸è¶³ï¼Œå…è¨±æ¶ˆè€—éƒ¨åˆ†æœ¬é‡‘ (USDT)ã€‚\n"
        advice += f"ç›®å‰åˆ©æ¯è¦†è“‹ç‡: {interest_coverage:.0f}%"
        source = "ä¾†æº: Pendle åˆ©æ¯ / USDT æœ¬é‡‘"
        
    return advice, source

def generate_line_message(status, today_date):
    assets = USER_CONFIG['CURRENT_ASSETS']
    tent = USER_CONFIG['CASH_TENT_SIZE']
    date_str = today_date.strftime('%Y-%m-%d')
    
    msg = f"\n[ğŸ° V44 æ”¶ç§Ÿæˆ°å ±] {date_str}\n"
    msg += f"ç¸½è³‡ç”¢: ${assets/10000:.0f}è¬\n"
    msg += f"ç¾é‡‘å¸³ç¯·: ${tent/10000:.0f}è¬ (ä¿å‘½éŒ¢)\n"
    
    vix = status['VIX']
    vix_state = "ğŸ”´ææ…Œ!" if status['IS_PANIC'] else "ğŸŸ¢å®‰å…¨"
    msg += f"ç’°å¢ƒ: VIX {vix:.1f} ({vix_state})\n"
    msg += "-" * 15 + "\n"
    
    # å¹£ç¨®æŒ‡ä»¤
    for coin in ['BTC', 'ETH', 'SOL']:
        s = status[coin]
        icon = "ğŸŸ¢" if s['Action'] == 1 else ("ğŸ”´" if s['Action'] == -1 else "ğŸŸ¡")
        msg += f"{icon} {coin} ({int(ALLOCATION[coin]*100)}%): {s['Signal']}\n"
    
    msg += "-" * 15 + "\n"
    
    # ææ¬¾å»ºè­°
    advice_text, source = get_withdrawal_advice(status)
    # ç°¡åŒ– LINE é¡¯ç¤º
    if status['MARKET_STATE'] == "BULL":
        msg += "ğŸ’µ [æœ¬æœˆææ¬¾]\nğŸ‘‰ ç›´æ¥è³£å¹£è®Šç¾ (è¢«å‹•æ­¢ç›ˆ)\n"
    else:
        msg += "ğŸ›¡ï¸ [æœ¬æœˆææ¬¾]\nğŸ‘‰ ä½¿ç”¨ Pendle åˆ©æ¯/ç¾é‡‘ (ä¿è­·æœ¬é‡‘)\n"
        
    return msg

def send_line_notify(message):
    token = USER_CONFIG['LINE_TOKEN']
    if token == 'æ‚¨çš„LINE_TOKEN_è²¼åœ¨é€™è£¡' or not token:
        print(f"{Fore.YELLOW}âš ï¸ æœªè¨­å®š LINE Token{Style.RESET}")
        return

    url = 'https://notify-api.line.me/api/notify'
    headers = {'Authorization': f'Bearer {token}'}
    data = {'message': message}
    try:
        requests.post(url, headers=headers, data=data)
        print(f"{Fore.GREEN}âœ… LINE é€šçŸ¥å·²ç™¼é€{Style.RESET}")
    except:
        print(f"{Fore.RED}âŒ LINE ç™¼é€å¤±æ•—{Style.RESET}")

# ==========================================
# 3. æˆ°æƒ…å„€è¡¨æ¿ (Console)
# ==========================================
def print_dashboard(status, today_date):
    assets = USER_CONFIG['CURRENT_ASSETS']
    tent = USER_CONFIG['CASH_TENT_SIZE']
    monthly = USER_CONFIG['MONTHLY_WITHDRAW']
    
    print("\n" + "="*60)
    print(f"{Fore.CYAN}ğŸ° V44 Hyper æ”¶ç§Ÿç‰ˆæˆ°æƒ…å®¤ (Retirement Mode){Style.RESET}")
    print(f"ğŸ“… æ—¥æœŸ: {today_date.strftime('%Y-%m-%d')}")
    print(f"ğŸ’° ç¸½è³‡ç”¢: ${assets:,.0f}")
    print(f"â›º ç¾é‡‘å¸³ç¯·: ${tent:,.0f} (å®‰å…¨æ°´ä½)")
    print(f"ğŸ’¸ æ¯æœˆå‰›éœ€: ${monthly:,.0f}")
    print("="*60)
    
    vix = status['VIX']
    vix_str = f"{Fore.RED}{vix:.2f} (ææ…Œ!){Style.RESET}" if status['IS_PANIC'] else f"{Fore.GREEN}{vix:.2f} (å®‰å…¨){Style.RESET}"
    print(f"ğŸŒ å¸‚å ´æ°£è±¡ (VIX): {vix_str}")
    print("-" * 60)
    
    print(f"{Fore.YELLOW}âš”ï¸ æŠ•è³‡çµ„åˆ (é˜²å®ˆå‹é…ç½®) æ“ä½œæŒ‡ä»¤:{Style.RESET}")
    for coin in ['BTC', 'ETH', 'SOL']:
        s = status[coin]
        if s['Action'] == 1: color = Fore.GREEN
        elif s['Action'] == -1: color = Fore.RED
        else: color = Fore.YELLOW
        
        print(f"ğŸ’ {coin:<3} ({int(ALLOCATION[coin]*100)}%): {Fore.WHITE}${s['Price']:,.2f}{Style.RESET}")
        print(f"   â€¢ SMA140: ${s['SMA_140']:,.0f}")
        print(f"   â€¢ Mayer:  {s['Mayer']:.2f}")
        print(f"   ğŸ‘‰ æŒ‡ä»¤: {Style.BRIGHT}{color}{s['Signal']}{Style.RESET}")
        print("-" * 20)

    # ææ¬¾å»ºè­°å€å¡Š
    advice, source = get_withdrawal_advice(status)
    print(f"\n{Fore.MAGENTA}ğŸ›¡ï¸ é›™æ²¹ç®±ææ¬¾æŒ‡å¼•:{Style.RESET}")
    print(advice)
    print(f"ğŸ‘‰ è³‡é‡‘ä¾†æº: {Fore.CYAN}{source}{Style.RESET}")
    
    print("="*60)
    
    # ç´€å¾‹æé†’
    print(f"\n{Fore.CYAN}ğŸ§˜ é€€ä¼‘å¿ƒæ…‹èˆ‡ç´€å¾‹æé†’:{Style.RESET}")
    if status['MARKET_STATE'] == "BULL":
        print("   ğŸ˜ [ç‰›å¸‚]: è³‡ç”¢æ­£åœ¨å¢å€¼ï¼Œè«‹å®‰å¿ƒææ¬¾å»äº«å—ç”Ÿæ´»ã€‚")
        print("   ğŸ‘‰ è¨˜å¾—ä¸è¦æŠŠç”Ÿæ´»è²»æ‹¿å›å»åŠ å€‰ï¼Œé‚£æ˜¯è²ªå©ªçš„é–‹å§‹ã€‚")
    else:
        print("   ğŸ›¡ï¸ [ç†Šå¸‚]: è³‡ç”¢æš«æ™‚ç¸®æ°´æ˜¯æ­£å¸¸çš„ï¼Œä¸è¦ææ…Œã€‚")
        print("   ğŸ‘‰ æ‚¨çš„ç¾é‡‘å¸³ç¯·å’Œåˆ©æ¯è¶³å¤ æ”¯æ’ç”Ÿæ´»ï¼Œä¸ç”¨è³¤è³£è³‡ç”¢ã€‚")
        print("   ğŸ‘‰ é—œæ‰çœ‹ç›¤è»Ÿé«”ï¼Œå»å…¬åœ’æ•£æ­¥å§ã€‚")
    print("="*60 + "\n")

# ==========================================
# ä¸»ç¨‹å¼
# ==========================================
if __name__ == "__main__":
    try:
        raw = fetch_data()
        processed = process_data(raw)
        if processed and 'BTC' in processed:
            stat, today = analyze_market(processed)
            print_dashboard(stat, today)
            line_msg = generate_line_message(stat, today)
            send_line_notify(line_msg)
        else:
            print("âŒ ç„¡æ³•ç²å–æ•¸æ“š")
    except Exception as e:
        print(f"âŒ éŒ¯èª¤: {e}")
