# ==========================================
# Gemini V44 Hyper: Retirement Engine (Messaging API + Lazy Summary)
# ------------------------------------------
# [æˆ°ç•¥ç›®æ¨™]
# å°ˆç‚ºã€Œæ°¸çºŒæ”¶ç§ŸæœŸ (Retirement Phase)ã€è¨­è¨ˆã€‚
# é‡é»åœ¨æ–¼ä¿æœ¬ã€ç¾é‡‘æµç®¡ç†èˆ‡ææ¬¾ç´€å¾‹ã€‚
#
# [æ ¸å¿ƒåŠŸèƒ½]
# 1. ç­–ç•¥: V44 Hyper é˜²å®ˆå‹ (50% BTC / 40% ETH / 10% SOL)
# 2. ææ¬¾: è‡ªå‹•åˆ¤æ–·æœ¬æœˆè©²ã€Œè³£å¹£æ­¢ç›ˆã€é‚„æ˜¯ã€Œä½¿ç”¨åˆ©æ¯/æœ¬é‡‘ã€ã€‚
# 3. é€šçŸ¥: æ”¯æ´ GitHub Secrets (Messaging API) èˆ‡æ“ä½œæ‡¶äººåŒ…ã€‚
# ==========================================

import os
import sys
import requests
import json
import warnings
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

warnings.filterwarnings("ignore")

# ==========================================
# 0. ç’°å¢ƒæª¢æŸ¥èˆ‡ LINE è¨­å®š (Messaging API)
# ==========================================
print("="*50)
print("ğŸ” V44 æ”¶ç§Ÿç³»çµ±å•Ÿå‹• (Messaging API)...")

# è®€å– GitHub Secrets
LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_USER_ID = os.environ.get('LINE_USER_ID')

# æœ¬åœ°æ¸¬è©¦ç”¨ (ä¸Šå‚³ GitHub å‰è«‹ä¿æŒç‚ºç©º)
LOCAL_TOKEN = ''
LOCAL_USER_ID = ''

FINAL_TOKEN = LINE_CHANNEL_ACCESS_TOKEN if LINE_CHANNEL_ACCESS_TOKEN else LOCAL_TOKEN
FINAL_USER_ID = LINE_USER_ID if LINE_USER_ID else LOCAL_USER_ID

if FINAL_TOKEN and FINAL_USER_ID:
    print(f"âœ… LINE é‡‘é‘°è®€å–æˆåŠŸ")
else:
    print("âŒ è­¦å‘Šï¼šæœªæª¢æ¸¬åˆ° LINE é‡‘é‘°ï¼(è«‹æª¢æŸ¥ GitHub Secrets)")

def send_line_push(msg):
    if not FINAL_TOKEN or not FINAL_USER_ID:
        print("âš ï¸ è·³éç™¼é€ï¼šé‡‘é‘°ä¸å®Œæ•´")
        return

    url = 'https://api.line.me/v2/bot/message/push'
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {FINAL_TOKEN}'
    }
    payload = {
        "to": FINAL_USER_ID,
        "messages": [{"type": "text", "text": msg}]
    }
    
    try:
        print("ğŸ“¤ æ­£åœ¨æ¨é€ LINE è¨Šæ¯...")
        response = requests.post(url, headers=headers, json=payload)
        if response.status_code == 200:
            print("âœ… ç™¼é€æˆåŠŸï¼")
        else:
            print(f"âŒ ç™¼é€å¤±æ•—: {response.status_code} {response.text}")
    except Exception as e:
        print(f"âŒ ç¶²çµ¡éŒ¯èª¤: {e}")

# è‡ªå‹•å®‰è£ä¾è³´
try:
    import yfinance as yf
except ImportError:
    print("ğŸ“¦ å®‰è£ yfinance...")
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
    import yfinance as yf

try:
    from colorama import Fore, Style, init
    init(autoreset=True)
except:
    class Fore: RED=GREEN=YELLOW=CYAN=MAGENTA=WHITE=RESET=""
    class Style: BRIGHT=RESET_ALL=""

# ==========================================
# âš™ï¸ ç”¨æˆ¶è¨­å®š
# ==========================================
USER_CONFIG = {
    'CURRENT_ASSETS': 30000000,   # ç›®å‰ç¸½è³‡ç”¢ (TWD)
    'CASH_TENT_SIZE': 6000000,    # ç¾é‡‘å¸³ç¯·æ°´ä½ (TWD) - ä¿å‘½éŒ¢
    'MONTHLY_WITHDRAW': 166666,   # æ¯æœˆé è¨ˆæé ˜é‡‘é¡ (TWD)
    'PENDLE_INTEREST_RATE': 0.05, # ç›®å‰ Pendle/ç¾å‚µ å¹´åŒ–åˆ©ç‡ (5%)
}

# ç­–ç•¥åƒæ•¸ (é˜²å®ˆå‹)
STRATEGY_PARAMS = {
    'SMA_TREND': 140,
    'SMA_MAYER': 200,
    'VIX_PANIC': 30,
    'MAYER_GREED': 2.4
}

# æ¬Šé‡é…ç½® (Phase 2 - é˜²å®ˆå‹: é™ä½ SOL æ¯”ä¾‹)
ALLOCATION = {'BTC': 0.5, 'ETH': 0.4, 'SOL': 0.1}

# ==========================================
# 1. æ•¸æ“šå¼•æ“
# ==========================================
def fetch_data():
    print(f"\n{Fore.CYAN}ğŸ“¥ æ­£åœ¨æƒæå¸‚å ´æ•¸æ“š (é€€ä¼‘æ¨¡å¼)...{Style.RESET_ALL}")
    tickers = ['BTC-USD', 'ETH-USD', 'SOL-USD', '^VIX']
    start_date = (datetime.now() - timedelta(days=500)).strftime('%Y-%m-%d')
    try:
        data = yf.download(tickers, start=start_date, group_by='ticker', progress=False, auto_adjust=True)
        return data
    except:
        sys.exit()
    return data

def process_data(raw_data):
    data_map = {}
    ticker_to_symbol = {'BTC-USD': 'BTC', 'ETH-USD': 'ETH', 'SOL-USD': 'SOL', '^VIX': 'VIX'}
    
    # è™•ç† MultiIndex
    if isinstance(raw_data.columns, pd.MultiIndex):
        level_0_cols = raw_data.columns.levels[0]
    else:
        return {} 

    for ticker in level_0_cols:
        symbol = ticker_to_symbol.get(ticker)
        if not symbol: continue
        
        df = pd.DataFrame()
        try: 
            col = 'Close' if 'Close' in raw_data[ticker].columns else 'Adj Close'
            df['Close'] = raw_data[ticker][col]
        except: continue
        
        if df['Close'].isnull().all(): continue
        df.ffill(inplace=True)
        
        df['SMA_140'] = df['Close'].rolling(window=140).mean()
        df['SMA_200'] = df['Close'].rolling(window=200).mean()
        df['Mayer'] = df['Close'] / df['SMA_200']
        
        data_map[symbol] = df
    return data_map

# ==========================================
# 2. ç­–ç•¥é‚è¼¯ & ææ¬¾å»ºè­°
# ==========================================
def analyze_market(data_map):
    status = {}
    if 'BTC' not in data_map: return {}, None
    today = data_map['BTC'].index[-1]
    
    try: vix = data_map['VIX'].loc[today]['Close']
    except: vix = 20.0
    status['VIX'] = vix
    status['IS_PANIC'] = vix > STRATEGY_PARAMS['VIX_PANIC']
    
    # åˆ¤æ–·æ•´é«”è¶¨å‹¢ (ç”¨æ–¼ææ¬¾å»ºè­°)
    bull_count = 0
    
    # å…ˆåˆ¤æ–· BTC (å¤§å“¥æ¿¾ç¶²)
    btc_row = data_map['BTC'].loc[today]
    is_btc_bull = btc_row['Close'] > btc_row['SMA_140']
    
    coins_config = {
        'BTC': {'name': 'Bitcoin', 'weight': 0.50, 'role': 'æ ¸å¿ƒ'},
        'ETH': {'name': 'Ethereum', 'weight': 0.40, 'role': 'æ ¸å¿ƒ'},
        'SOL': {'name': 'Solana', 'weight': 0.10, 'role': 'è¡›æ˜Ÿ(è¼•å€‰)'}
    }

    for coin in ['BTC', 'ETH', 'SOL']:
        row = data_map[coin].loc[today]
        price = row['Close']
        sma = row['SMA_140']
        mayer = row['Mayer']
        
        signal_text = "HOLD"
        action_short = "æŒæœ‰"
        
        if status['IS_PANIC']:
            signal_text = "ğŸŒªï¸ ææ…Œé¿éšª"
            action_short = "æ¸…å€‰"
        
        elif coin == 'SOL' and not is_btc_bull:
            signal_text = "ğŸ›‘ è¯å‹•é¿éšª"
            action_short = "æ¸…å€‰"
            
        elif mayer > STRATEGY_PARAMS['MAYER_GREED']:
            signal_text = "âš ï¸ éç†±æ¸›ç¢¼"
            action_short = "æ¸›å€‰"
            bull_count += 1
            
        elif price > sma:
            signal_text = "ğŸš€ è¶¨å‹¢æŒæœ‰"
            action_short = "æ»¿å€‰"
            bull_count += 1
            
        else:
            signal_text = "ğŸ›‘ ç©ºå€‰è§€æœ›"
            action_short = "ç©ºå€‰"
            
        status[coin] = {
            'Name': coins_config[coin]['name'],
            'BaseWeight': coins_config[coin]['weight'],
            'Price': price, 'SMA_140': sma, 'Mayer': mayer,
            'SignalText': signal_text, 'ActionShort': action_short
        }
    
    status['MARKET_STATE'] = "BULL" if bull_count >= 2 else "BEAR"
    return status, today

def get_withdrawal_advice(status):
    monthly = USER_CONFIG['MONTHLY_WITHDRAW']
    assets = USER_CONFIG['CURRENT_ASSETS']
    
    # è¨ˆç®—é ä¼°åˆ©æ¯æ”¶å…¥ (å‡è¨­å…¨ç¾é‡‘åœ¨ Pendle)
    yearly_interest = assets * 0.8 * USER_CONFIG['PENDLE_INTEREST_RATE'] 
    interest_coverage = (yearly_interest / (monthly * 12)) * 100
    
    advice = ""
    source = ""
    short_advice = ""
    
    if status['MARKET_STATE'] == "BULL":
        advice = f"ğŸŸ¢ [ç‰›å¸‚ææ¬¾å»ºè­°]\n"
        advice += f"æœ¬æœˆè«‹ç›´æ¥ã€Œè³£å¹£ã€æé ˜ ${monthly:,.0f}ã€‚\n"
        advice += "é€™å±¬æ–¼è¢«å‹•æ­¢ç›ˆï¼Œåœ¨è³‡ç”¢å¢å€¼æ™‚ä¿®å‰ªæ¨¹æã€‚"
        source = "ä¾†æº: äº¤æ˜“æ‰€è³£å¹£"
        short_advice = "è³£å¹£è®Šç¾"
    else:
        advice = f"ğŸ”´ [ç†Šå¸‚/ç©ºå€‰ææ¬¾å»ºè­°]\n"
        advice += f"æœ¬æœˆè«‹ä½¿ç”¨ã€ŒPendle åˆ©æ¯ã€æé ˜ ${monthly:,.0f}ã€‚\n"
        advice += f"è‹¥åˆ©æ¯ä¸è¶³ï¼Œå…è¨±æ¶ˆè€—éƒ¨åˆ†æœ¬é‡‘ (USDT)ã€‚\n"
        advice += f"ç›®å‰åˆ©æ¯è¦†è“‹ç‡: {interest_coverage:.0f}%"
        source = "ä¾†æº: Pendle åˆ©æ¯ / USDT æœ¬é‡‘"
        short_advice = "ä½¿ç”¨åˆ©æ¯"
        
    return advice, source, short_advice

def get_discipline_msg(status):
    msg = ""
    if status['MARKET_STATE'] == "BULL":
        msg += "ğŸ˜ ç‰›å¸‚ï¼šè³‡ç”¢æ­£åœ¨å¢å€¼ï¼Œè«‹å®‰å¿ƒææ¬¾äº«å—ç”Ÿæ´»ã€‚\n"
        msg += "âš ï¸ ç´€å¾‹ï¼šå‹¿å°‡ç”Ÿæ´»è²»åŠ å€‰ï¼Œé‚£æ˜¯è²ªå©ªçš„é–‹å§‹ã€‚"
    else:
        msg += "ğŸ›¡ï¸ ç†Šå¸‚ï¼šè³‡ç”¢æš«æ™‚ç¸®æ°´æ˜¯æ­£å¸¸çš„ï¼Œä¸è¦ææ…Œã€‚\n"
        msg += "âš ï¸ ç´€å¾‹ï¼šç¾é‡‘å¸³ç¯·è¶³å¤ æ”¯æ’ï¼Œé é›¢ç›¤é¢ã€‚"
    return msg

# ==========================================
# 3. è¨Šæ¯ç”Ÿæˆ (Report Generator)
# ==========================================
def generate_report(status, today_date):
    assets = USER_CONFIG['CURRENT_ASSETS']
    tent = USER_CONFIG['CASH_TENT_SIZE']
    date_str = today_date.strftime('%Y-%m-%d')
    
    _, _, withdraw_short = get_withdrawal_advice(status)
    
    # --- æ‡¶äººåŒ…å€å¡Š ---
    msg = f"ğŸ“‹ {date_str} æ”¶ç§Ÿæ‡¶äººåŒ…\n"
    msg += f"-------------------------\n"
    msg += f"ğŸŸ  BTC: {status['BTC']['ActionShort']}\n"
    msg += f"ğŸ”µ ETH: {status['ETH']['ActionShort']}\n"
    msg += f"ğŸŸ£ SOL: {status['SOL']['ActionShort']}\n"
    msg += f"ğŸ’µ ææ¬¾: {withdraw_short}\n"
    msg += f"-------------------------\n\n"
    
    # --- è©³ç´°å€å¡Š ---
    msg += f"ğŸ° V44 æ”¶ç§Ÿæˆ°å ±\n"
    msg += f"=========================\n"
    msg += f"ç¸½è³‡ç”¢: ${assets/10000:.0f}è¬\n"
    msg += f"ç¾é‡‘å¸³ç¯·: ${tent/10000:.0f}è¬ (ä¿å‘½éŒ¢)\n"
    
    vix = status['VIX']
    vix_state = "ğŸ”´ææ…Œ!" if status['IS_PANIC'] else "ğŸŸ¢å®‰å…¨"
    msg += f"ç’°å¢ƒ: VIX {vix:.1f} ({vix_state})\n"
    msg += "-" * 20 + "\n"
    
    # å¹£ç¨®æŒ‡ä»¤
    icons = {'BTC': 'ğŸŸ ', 'ETH': 'ğŸ”µ', 'SOL': 'ğŸŸ£'}
    for coin in ['BTC', 'ETH', 'SOL']:
        s = status[coin]
        icon = icons[coin]
        weight_display = int(s['BaseWeight'] * 100)
        trend_status = "âœ…" if s['Price'] > s['SMA_140'] else "âŒ"
        
        msg += f"{icon} {coin} ({weight_display}%): {s['ActionShort']}\n"
        msg += f"   ${s['Price']:,.0f} (MA ${s['SMA_140']:,.0f}) {trend_status}\n"
        msg += f"   æŒ‡ä»¤: {s['SignalText']}\n"
    
    msg += "-" * 20 + "\n"
    
    # ææ¬¾å»ºè­°
    advice_text, source, _ = get_withdrawal_advice(status)
    
    if status['MARKET_STATE'] == "BULL":
        msg += "ğŸŸ¢ [æœ¬æœˆææ¬¾]\nğŸ‘‰ ç›´æ¥è³£å¹£è®Šç¾ (è¢«å‹•æ­¢ç›ˆ)\n"
    else:
        msg += "ğŸ›¡ï¸ [æœ¬æœˆææ¬¾]\nğŸ‘‰ ä½¿ç”¨ Pendle åˆ©æ¯/ç¾é‡‘ (ä¿è­·æœ¬é‡‘)\n"
        
    # ç´€å¾‹æé†’
    msg += f"\nğŸ’¡ é€€ä¼‘ç´€å¾‹:\n"
    msg += get_discipline_msg(status)
    
    return msg

# ==========================================
# 4. æˆ°æƒ…å„€è¡¨æ¿ (Console Preview)
# ==========================================
def print_dashboard_preview(msg):
    print("\n" + msg)

# ==========================================
# ä¸»ç¨‹å¼
# ==========================================
if __name__ == "__main__":
    try:
        raw = fetch_data()
        processed = process_data(raw)
        if processed and 'BTC' in processed:
            stat, today = analyze_market(processed)
            line_msg = generate_report(stat, today)
            # print(line_msg) # æœ¬æ©Ÿé è¦½
            send_line_push(line_msg)
        else:
            print("âŒ ç„¡æ³•ç²å–æ•¸æ“š")
    except Exception as e:
        print(f"âŒ éŒ¯èª¤: {e}")
