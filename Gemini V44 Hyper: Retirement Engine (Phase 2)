# ==========================================
# Gemini V44 Hyper: Retirement Engine (Messaging API Edition)
# ------------------------------------------
# é€™æ˜¯å°ˆç‚ºã€Œæ°¸çºŒæ”¶ç§ŸæœŸ (Retirement Phase)ã€è¨­è¨ˆçš„åŸ·è¡Œè…³æœ¬ã€‚
# 
# [åŠŸèƒ½èªªæ˜]
# 1. ç­–ç•¥: V44 Hyper é˜²å®ˆå‹ (50% BTC / 40% ETH / 10% SOL)
# 2. ææ¬¾: è‡ªå‹•åˆ¤æ–·æœ¬æœˆè©²ã€Œè³£å¹£æ­¢ç›ˆã€é‚„æ˜¯ã€Œä½¿ç”¨åˆ©æ¯/æœ¬é‡‘ã€ã€‚
# 3. é€šçŸ¥: æ”¯æ´ GitHub Secrets (Messaging API) èˆ‡æ“ä½œæ‡¶äººåŒ…ã€‚
# ==========================================

import os
import sys
import requests
import json
import warnings
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

warnings.filterwarnings("ignore")

# ==========================================
# 0. ç’°å¢ƒæª¢æŸ¥èˆ‡ LINE è¨­å®š (Messaging API)
# ==========================================
print("="*50)
print("ğŸ” V44 æ”¶ç§Ÿç³»çµ±å•Ÿå‹•è‡ªæˆ‘è¨ºæ–·...")

# è®€å– GitHub Secrets
LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_USER_ID = os.environ.get('LINE_USER_ID')

# æœ¬åœ°æ¸¬è©¦ç”¨ (å¦‚æœåœ¨æœ¬åœ°è·‘ï¼Œè«‹å¡«å…¥æ‚¨çš„ Token/IDï¼Œä¸Šå‚³ GitHub å‰è«‹æ¸…ç©º)
LOCAL_TOKEN = ''
LOCAL_USER_ID = ''

if not LINE_CHANNEL_ACCESS_TOKEN and LOCAL_TOKEN:
    LINE_CHANNEL_ACCESS_TOKEN = LOCAL_TOKEN
if not LINE_USER_ID and LOCAL_USER_ID:
    LINE_USER_ID = LOCAL_USER_ID

if LINE_CHANNEL_ACCESS_TOKEN and LINE_USER_ID:
    print(f"âœ… Token è®€å–æˆåŠŸ: {LINE_CHANNEL_ACCESS_TOKEN[:5]}...")
    print(f"âœ… UserID è®€å–æˆåŠŸ: {LINE_USER_ID[:5]}...")
else:
    print("âŒ è­¦å‘Šï¼šæœªæª¢æ¸¬åˆ° LINE é‡‘é‘°ï¼å°‡ç„¡æ³•ç™¼é€é€šçŸ¥ã€‚")
    print("   è«‹ç¢ºèª GitHub Secrets: 'LINE_CHANNEL_ACCESS_TOKEN' èˆ‡ 'LINE_USER_ID'")

def send_line_push(msg):
    if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_USER_ID:
        print("âš ï¸ è·³éç™¼é€ï¼šé‡‘é‘°ä¸å®Œæ•´")
        return

    url = 'https://api.line.me/v2/bot/message/push'
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {LINE_CHANNEL_ACCESS_TOKEN}'
    }
    payload = {
        "to": LINE_USER_ID,
        "messages": [{"type": "text", "text": msg}]
    }
    
    try:
        print("ğŸ“¤ æ­£åœ¨æ¨é€ LINE è¨Šæ¯...")
        response = requests.post(url, headers=headers, json=payload)
        if response.status_code == 200:
            print("âœ… ç™¼é€æˆåŠŸï¼")
        else:
            print(f"âŒ ç™¼é€å¤±æ•—: {response.status_code} {response.text}")
    except Exception as e:
        print(f"âŒ ç¶²çµ¡éŒ¯èª¤: {e}")

# è‡ªå‹•å®‰è£ä¾è³´
try:
    import yfinance as yf
except ImportError:
    print("ğŸ“¦ æ­£åœ¨å®‰è£å¿…è¦å¥—ä»¶ (yfinance)...")
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
    import yfinance as yf

try:
    import colorama
    from colorama import Fore, Style
    colorama.init(autoreset=True)
except ImportError:
    class Fore: RED=GREEN=YELLOW=CYAN=MAGENTA=WHITE=RESET=""
    class Style: BRIGHT=RESET=""

# ==========================================
# âš™ï¸ ç”¨æˆ¶è¨­å®š (USER_CONFIG)
# ==========================================
USER_CONFIG = {
    'CURRENT_ASSETS': 30000000,   # ç›®å‰ç¸½è³‡ç”¢ (TWD)
    'CASH_TENT_SIZE': 6000000,    # ç¾é‡‘å¸³ç¯·æ°´ä½ (TWD) - ä¿å‘½éŒ¢
    'MONTHLY_WITHDRAW': 166666,   # æ¯æœˆé è¨ˆæé ˜é‡‘é¡ (TWD)
    'PENDLE_INTEREST_RATE': 0.05, # ç›®å‰ Pendle/ç¾å‚µ å¹´åŒ–åˆ©ç‡ (5%)
}

# ç­–ç•¥åƒæ•¸ (é˜²å®ˆå‹)
STRATEGY_PARAMS = {
    'SMA_TREND': 140,
    'SMA_MAYER': 200,
    'VIX_PANIC': 30,
    'MAYER_GREED': 2.4
}

# æ¬Šé‡é…ç½® (Phase 2 - é˜²å®ˆå‹)
ALLOCATION = {'BTC': 0.5, 'ETH': 0.4, 'SOL': 0.1}

# ==========================================
# 1. æ•¸æ“šå¼•æ“
# ==========================================
def fetch_data():
    print(f"\n{Fore.CYAN}ğŸ“¥ æ­£åœ¨æƒæå¸‚å ´æ•¸æ“š (é€€ä¼‘æ¨¡å¼)...{Style.RESET}")
    tickers = ['BTC-USD', 'ETH-USD', 'SOL-USD', '^VIX']
    start_date = (datetime.now() - timedelta(days=500)).strftime('%Y-%m-%d')
    try:
        data = yf.download(tickers, start=start_date, group_by='ticker', progress=False)
    except Exception as e:
        print(f"{Fore.RED}âŒ æ•¸æ“šä¸‹è¼‰å¤±æ•—: {e}{Style.RESET}")
        sys.exit()
    return data

def process_data(raw_data):
    data_map = {}
    tickers_map = {'BTC': 'BTC-USD', 'ETH': 'ETH-USD', 'SOL': 'SOL-USD', 'VIX': '^VIX'}
    
    for symbol, ticker in tickers_map.items():
        df = pd.DataFrame()
        try:
            if ticker in raw_data.columns.levels[0]:
                df['Close'] = raw_data[ticker]['Close']
            elif ticker == 'BTC-USD': 
                 if 'Close' in raw_data.columns: df['Close'] = raw_data['Close']
        except: pass
            
        if df.empty: continue
        df.ffill(inplace=True)
        
        df['SMA_140'] = df['Close'].rolling(window=140).mean()
        df['SMA_200'] = df['Close'].rolling(window=200).mean()
        df['Mayer'] = df['Close'] / df['SMA_200']
        
        data_map[symbol] = df
    return data_map

def analyze_market(data_map):
    status = {}
    today = data_map['BTC'].index[-1]
    
    try: vix = data_map['VIX'].loc[today]['Close']
    except: vix = 20.0
    status['VIX'] = vix
    status['IS_PANIC'] = vix > STRATEGY_PARAMS['VIX_PANIC']
    
    # åˆ¤æ–·æ•´é«”è¶¨å‹¢ (ç”¨æ–¼ææ¬¾å»ºè­°)
    bull_count = 0
    
    # å…ˆåˆ¤æ–· BTC (å¤§å“¥æ¿¾ç¶²)
    btc_row = data_map['BTC'].loc[today]
    is_btc_bull = btc_row['Close'] > btc_row['SMA_140']
    
    coins_config = {
        'BTC': {'name': 'Bitcoin', 'weight': 0.50, 'role': 'æ ¸å¿ƒ'},
        'ETH': {'name': 'Ethereum', 'weight': 0.40, 'role': 'æ ¸å¿ƒ'},
        'SOL': {'name': 'Solana', 'weight': 0.10, 'role': 'è¡›æ˜Ÿ(è¼•å€‰)'}
    }

    for coin in ['BTC', 'ETH', 'SOL']:
        row = data_map[coin].loc[today]
        price = row['Close']
        sma = row['SMA_140']
        mayer = row['Mayer']
        
        signal_text = "HOLD"
        action_short = "æŒæœ‰"
        
        if status['IS_PANIC']:
            signal_text = "ğŸŒªï¸ ææ…Œé¿éšª"
            action_short = "æ¸…å€‰"
        
        elif coin == 'SOL' and not is_btc_bull:
            signal_text = "ğŸ›‘ è¯å‹•é¿éšª"
            action_short = "æ¸…å€‰"
            
        elif mayer > STRATEGY_PARAMS['MAYER_GREED']:
            signal_text = "âš ï¸ éç†±æ¸›ç¢¼"
            action_short = "æ¸›å€‰"
            bull_count += 1
            
        elif price > sma:
            signal_text = "ğŸš€ è¶¨å‹¢æŒæœ‰"
            action_short = "æ»¿å€‰"
            bull_count += 1
            
        else:
            signal_text = "ğŸ›‘ ç©ºå€‰è§€æœ›"
            action_short = "ç©ºå€‰"
            
        status[coin] = {
            'Name': coins_config[coin]['name'],
            'BaseWeight': coins_config[coin]['weight'],
            'Price': price, 'SMA_140': sma, 'Mayer': mayer,
            'SignalText': signal_text, 'ActionShort': action_short
        }
    
    status['MARKET_STATE'] = "BULL" if bull_count >= 2 else "BEAR"
    return status, today

# ==========================================
# 2. ææ¬¾å»ºè­°æ¨¡çµ„
# ==========================================
def get_withdrawal_advice(status):
    monthly = USER_CONFIG['MONTHLY_WITHDRAW']
    tent = USER_CONFIG['CASH_TENT_SIZE']
    assets = USER_CONFIG['CURRENT_ASSETS']
    
    # è¨ˆç®—é ä¼°åˆ©æ¯æ”¶å…¥ (è‹¥å…¨ç¾é‡‘)
    yearly_interest = assets * 0.8 * USER_CONFIG['PENDLE_INTEREST_RATE'] 
    interest_coverage = (yearly_interest / (monthly * 12)) * 100
    
    advice = ""
    source = ""
    short_advice = ""
    
    if status['MARKET_STATE'] == "BULL":
        advice = f"ğŸŸ¢ [ç‰›å¸‚ææ¬¾å»ºè­°]\n"
        advice += f"æœ¬æœˆè«‹ç›´æ¥ã€Œè³£å¹£ã€æé ˜ ${monthly:,.0f}ã€‚\n"
        advice += "é€™å±¬æ–¼è¢«å‹•æ­¢ç›ˆï¼Œåœ¨è³‡ç”¢å¢å€¼æ™‚ä¿®å‰ªæ¨¹æã€‚"
        source = "ä¾†æº: äº¤æ˜“æ‰€è³£å¹£"
        short_advice = "è³£å¹£è®Šç¾"
    else:
        advice = f"ğŸ”´ [ç†Šå¸‚/ç©ºå€‰ææ¬¾å»ºè­°]\n"
        advice += f"æœ¬æœˆè«‹ä½¿ç”¨ã€ŒPendle åˆ©æ¯ã€æé ˜ ${monthly:,.0f}ã€‚\n"
        advice += f"è‹¥åˆ©æ¯ä¸è¶³ï¼Œå…è¨±æ¶ˆè€—éƒ¨åˆ†æœ¬é‡‘ (USDT)ã€‚\n"
        advice += f"ç›®å‰åˆ©æ¯è¦†è“‹ç‡: {interest_coverage:.0f}%"
        source = "ä¾†æº: Pendle åˆ©æ¯ / USDT æœ¬é‡‘"
        short_advice = "ä½¿ç”¨åˆ©æ¯"
        
    return advice, source, short_advice

# ==========================================
# 3. è¨Šæ¯ç”Ÿæˆ (Report Generator)
# ==========================================
def generate_report(status, today_date):
    assets = USER_CONFIG['CURRENT_ASSETS']
    tent = USER_CONFIG['CASH_TENT_SIZE']
    date_str = today_date.strftime('%Y-%m-%d')
    
    _, _, withdraw_short = get_withdrawal_advice(status)
    
    # --- æ‡¶äººåŒ…å€å¡Š ---
    msg = f"ğŸ“‹ {date_str} æ”¶ç§Ÿæ‡¶äººåŒ…\n"
    msg += f"-------------------------\n"
    msg += f"ğŸŸ  BTC: {status['BTC']['ActionShort']}\n"
    msg += f"ğŸ”µ ETH: {status['ETH']['ActionShort']}\n"
    msg += f"ğŸŸ£ SOL: {status['SOL']['ActionShort']}\n"
    msg += f"ğŸ’µ ææ¬¾: {withdraw_short}\n"
    msg += f"-------------------------\n\n"
    
    # --- è©³ç´°å€å¡Š ---
    msg += f"ğŸ° V44 æ”¶ç§Ÿæˆ°å ±\n"
    msg += f"=========================\n"
    msg += f"ç¸½è³‡ç”¢: ${assets/10000:.0f}è¬\n"
    msg += f"ç¾é‡‘å¸³ç¯·: ${tent/10000:.0f}è¬ (ä¿å‘½éŒ¢)\n"
    
    vix = status['VIX']
    vix_state = "ğŸ”´ææ…Œ!" if status['IS_PANIC'] else "ğŸŸ¢å®‰å…¨"
    msg += f"ç’°å¢ƒ: VIX {vix:.1f} ({vix_state})\n"
    msg += "-" * 15 + "\n"
    
    # å¹£ç¨®æŒ‡ä»¤
    icons = {'BTC': 'ğŸŸ ', 'ETH': 'ğŸ”µ', 'SOL': 'ğŸŸ£'}
    for coin in ['BTC', 'ETH', 'SOL']:
        s = status[coin]
        icon = icons[coin]
        weight_display = int(s['BaseWeight'] * 100)
        msg += f"{icon} {coin} ({weight_display}%): {s['ActionShort']}\n"
        msg += f"   ${s['Price']:,.0f} (MA ${s['SMA_140']:,.0f})\n"
        msg += f"   æŒ‡ä»¤: {s['SignalText']}\n"
    
    msg += "-" * 15 + "\n"
    
    # ææ¬¾å»ºè­°
    advice_text, source, _ = get_withdrawal_advice(status)
    
    if status['MARKET_STATE'] == "BULL":
        msg += "ğŸŸ¢ [æœ¬æœˆææ¬¾]\nğŸ‘‰ ç›´æ¥è³£å¹£è®Šç¾ (è¢«å‹•æ­¢ç›ˆ)\n"
    else:
        msg += "ğŸ›¡ï¸ [æœ¬æœˆææ¬¾]\nğŸ‘‰ ä½¿ç”¨ Pendle åˆ©æ¯/ç¾é‡‘ (ä¿è­·æœ¬é‡‘)\n"
    
    # ç´€å¾‹æé†’
    msg += f"\nğŸ’¡ é€€ä¼‘ç´€å¾‹:\n"
    if status['MARKET_STATE'] == "BULL":
        msg += "ç‰›å¸‚è«‹å®‰å¿ƒææ¬¾äº«å—ç”Ÿæ´»ã€‚\nå‹¿å°‡ç”Ÿæ´»è²»åŠ å€‰ï¼Œé‚£æ˜¯è²ªå©ªã€‚"
    else:
        msg += "ç†Šå¸‚è³‡ç”¢ç¸®æ°´æ­£å¸¸ï¼Œå‹¿ææ…Œã€‚\nç¾é‡‘å¸³ç¯·è¶³å¤ æ”¯æ’ï¼Œé é›¢ç›¤é¢ã€‚"
        
    return msg

# ==========================================
# 4. æˆ°æƒ…å„€è¡¨æ¿ (Console Preview)
# ==========================================
def print_dashboard(status, today_date):
    assets = USER_CONFIG['CURRENT_ASSETS']
    tent = USER_CONFIG['CASH_TENT_SIZE']
    monthly = USER_CONFIG['MONTHLY_WITHDRAW']
    
    print("\n" + "="*60)
    print(f"{Fore.CYAN}ğŸ° V44 Hyper æ”¶ç§Ÿç‰ˆæˆ°æƒ…å®¤ (Retirement Mode){Style.RESET}")
    print(f"ğŸ“… æ—¥æœŸ: {today_date.strftime('%Y-%m-%d')}")
    print(f"ğŸ’° ç¸½è³‡ç”¢: ${assets:,.0f}")
    print(f"â›º ç¾é‡‘å¸³ç¯·: ${tent:,.0f} (å®‰å…¨æ°´ä½)")
    print(f"ğŸ’¸ æ¯æœˆå‰›éœ€: ${monthly:,.0f}")
    print("="*60)
    
    vix = status['VIX']
    vix_str = f"{Fore.RED}{vix:.2f} (ææ…Œ!){Style.RESET}" if status['IS_PANIC'] else f"{Fore.GREEN}{vix:.2f} (å®‰å…¨){Style.RESET}"
    print(f"ğŸŒ å¸‚å ´æ°£è±¡ (VIX): {vix_str}")
    print("-" * 60)
    
    print(f"{Fore.YELLOW}âš”ï¸ æŠ•è³‡çµ„åˆ (é˜²å®ˆå‹é…ç½®) æ“ä½œæŒ‡ä»¤:{Style.RESET}")
    for coin in ['BTC', 'ETH', 'SOL']:
        s = status[coin]
        if s['Action'] == 1: color = Fore.GREEN
        elif s['Action'] == -1: color = Fore.RED
        else: color = Fore.YELLOW
        
        print(f"ğŸ’ {coin:<3} ({int(ALLOCATION[coin]*100)}%): {Fore.WHITE}${s['Price']:,.2f}{Style.RESET}")
        print(f"   â€¢ SMA140: ${s['SMA_140']:,.0f}")
        print(f"   â€¢ Mayer:  {s['Mayer']:.2f}")
        print(f"   ğŸ‘‰ æŒ‡ä»¤: {Style.BRIGHT}{color}{s['SignalText']}{Style.RESET}")
        print("-" * 20)

    # ææ¬¾å»ºè­°å€å¡Š
    advice, source, _ = get_withdrawal_advice(status)
    print(f"\n{Fore.MAGENTA}ğŸ›¡ï¸ é›™æ²¹ç®±ææ¬¾æŒ‡å¼•:{Style.RESET}")
    print(advice)
    print(f"ğŸ‘‰ è³‡é‡‘ä¾†æº: {Fore.CYAN}{source}{Style.RESET}")
    
    print("="*60 + "\n")

# ==========================================
# ä¸»ç¨‹å¼
# ==========================================
if __name__ == "__main__":
    try:
        raw = fetch_data()
        processed = process_data(raw)
        if processed and 'BTC' in processed:
            stat, today = analyze_market(processed)
            
            # 1. å„€è¡¨æ¿
            print_dashboard(stat, today)
            
            # 2. LINE é€šçŸ¥ (Messaging API)
            line_msg = generate_report(stat, today)
            print("--- LINE é è¦½ ---\n" + line_msg) # æœ¬æ©Ÿé è¦½
            send_line_push(line_msg)
            
        else:
            print("âŒ ç„¡æ³•ç²å–æ•¸æ“š")
    except Exception as e:
        print(f"âŒ éŒ¯èª¤: {e}")
