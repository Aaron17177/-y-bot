# ==========================================
# Gemini V44 Super Nova (SN-Sentinel): Retirement Commander v8.8
# ------------------------------------------
# [ç¢ºç«‹é‚è¼¯ï¼šæ”¶ç§ŸæœŸçµ‚æ¥µå°é½Šç‰ˆ]
# 1. æ ¸å¿ƒ (90%): å‹•æ…‹å“¨å…µ (Sentinel)ï¼Œé€²æ”»é–å®š 50/30ï¼Œé˜²ç¦¦ 70/20ã€‚
# 2. è¡›æ˜Ÿ (10%): Lean 15 é›™æ˜Ÿè¼ªå‹• (5% + 5%)ï¼Œå°é½ŠåŸºæº–ç‰ˆã€Œç´”å‹•èƒ½ã€é¸å¹£ã€‚
# 3. é€€ä¼‘è–ªè³‡: èµ·è–ª 200 è¬ï¼Œæ¯å¹´ 1/1 è‡ªå‹•åŠ è–ª 10% (è¤‡åˆ©æˆé•·)ã€‚
# 4. å‹•æ…‹å¸³ç¯·: ç¾é‡‘å¸³ç¯·æ°´ä½ = ç•¶å‰å¹´é ˜é‡‘é¡ x 3 (ç‰©ç†éš”é›¢ä¿è­·)ã€‚
# 5. æŒ‡ä»¤é€šçŸ¥: æ•´åˆ LINE Messaging API æ¯æ—¥æ¨æ’­å¯¦æˆ°æˆ°å ±ã€‚
# ==========================================

import os
import sys
import requests
import warnings
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

warnings.filterwarnings("ignore")

# ==========================================
# 0. LINE å‚³é€æ¨¡çµ„ (Messaging API)
# ==========================================
# è«‹åœ¨ GitHub Secrets æˆ–æœ¬åœ°ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š
LINE_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_UID = os.environ.get('LINE_USER_ID')

def send_line_push(msg):
    if not LINE_TOKEN or not LINE_UID:
        print("âš ï¸ æœªæª¢æ¸¬åˆ° LINE é‡‘é‘°ï¼Œåƒ…åœ¨çµ‚ç«¯æ©Ÿè¼¸å‡ºï¼š")
        print(msg); return
    url = 'https://api.line.me/v2/bot/message/push'
    headers = {'Content-Type': 'application/json', 'Authorization': f'Bearer {LINE_TOKEN}'}
    payload = {"to": LINE_UID, "messages": [{"type": "text", "text": msg}]}
    try:
        res = requests.post(url, headers=headers, json=payload)
        if res.status_code == 200: print("âœ… LINE è¨Šæ¯æ¨æ’­æˆåŠŸï¼")
    except: print("âŒ ç¶²çµ¡éŒ¯èª¤")

# è‡ªå‹•å®‰è£ yfinance
try:
    import yfinance as yf
except ImportError:
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
    import yfinance as yf

# ==========================================
# âš™ï¸ æ¯æ—¥é€€ä¼‘å¸³æˆ¶ç¾æ³ (è«‹åœ¨æ­¤æ›´æ–°æ•¸æ“š)
# ==========================================
USER_ACCOUNT = {
    'BANK_CASH_TWD': 6000000.0,      # ğŸ‘ˆ 1. ç›®å‰éŠ€è¡Œ/ç¾å‚µå¸³ç¯·é¤˜é¡ (TWD)
    'CRYPTO_EQUITY_USDT': 750000.0,  # ğŸ‘ˆ 2. å¹£åœˆç›®å‰ç¸½è³‡ç”¢ (æŠ˜åˆ USDT)
    
    'INITIAL_SALARY_TWD': 166666.0,  # é€€ä¼‘ç¬¬ä¸€å¹´çš„æœˆè–ªåŸºæ•¸ (å¦‚ 16.6 è¬)
    'RETIRE_YEAR': 2025,             # é€€ä¼‘èµ·å§‹å¹´ä»½
    'SALARY_GROWTH': 0.10,           # æ¯å¹´åŠ è–ª 10%
    
    # --- ç›®å‰æŒå€‰ä½”æ¯” (äº¤æ˜“æ‰€ App çœ‹åˆ°çš„æ•¸æ“šï¼Œ0.0 ~ 1.0) ---
    'CURRENT_BTC_W': 0.0,           
    'CURRENT_ETH_W': 0.0,           
    'CURRENT_SAT_1_SYM': 'NONE',    
    'CURRENT_SAT_1_W': 0.0,
    'CURRENT_SAT_2_SYM': 'NONE',    
    'CURRENT_SAT_2_W': 0.0
}

# --- ç­–ç•¥åŸºæº–åƒæ•¸ (å°é½Šçµ‚æ¥µæ¡†æ¶) ---
REBALANCE_THRESHOLD = 0.05  # 5% é–€æª» (å®ˆè­·è¤‡åˆ©æœ€å¼·è£ç”²)
SAFE_BARRIER_TWD = 30000000.0
USD_TWD_RATE = 32.0
PENDLE_APY = 0.05           # é€€ä¼‘æœŸé›™ç«¯ä¿å®ˆ 5% APY

# ã€Lean 15 è¡›æ˜Ÿæ±  - æœ€å¼·å¯¦æˆ°åå–®ã€‘
SATELLITE_POOL = {
    'L1': ['SOL-USD', 'AVAX-USD', 'BNB-USD', 'SUI-USD', 'ADA-USD'],
    'MEME': ['DOGE-USD', 'SHIB-USD', 'PEPE24478-USD'],
    'AI_DEFI': ['RENDER-USD', 'INJ-USD'],
    'LEGACY': ['TRX-USD', 'XLM-USD', 'BCH-USD', 'LTC-USD', 'ZEC-USD']
}

# ==========================================
# 1. çµ‚æ¥µåˆ†æå¼•æ“ (å°é½Š v4.0 åŸºæº–ç‰ˆé‚è¼¯)
# ==========================================
def analyze_retirement_market():
    all_sats = [t for sub in SATELLITE_POOL.values() for t in sub]
    tickers = ['BTC-USD', 'ETH-USD', '^VIX'] + all_sats
    
    print(f"ğŸ“¥ æ­£åœ¨åŒæ­¥å…¨çƒæ•¸æ“šåº«èˆ‡è¨ˆç®—å“¨å…µä¿¡è™Ÿ...")
    start_str = (datetime.now() - timedelta(days=365)).strftime('%Y-%m-%d')
    data = yf.download(tickers, start=start_str, group_by='ticker', progress=False, auto_adjust=True)
    
    data_map = {}
    ticker_to_sector = {t.split('-')[0]: s for s, ts in SATELLITE_POOL.items() for t in ts}
    ticker_to_sector['PEPE24478'] = 'MEME'

    for ticker in data.columns.levels[0]:
        symbol = ticker.split('-')[0] if ticker != '^VIX' else 'VIX'
        df = data[ticker].copy().ffill()
        if df.empty or len(df) < 140: continue
        
        df['SMA_60'] = df['Close'].rolling(60).mean()
        df['SMA_140'] = df['Close'].rolling(140).mean()
        df['SMA_200'] = df['Close'].rolling(200).mean()
        df['Ret_20'] = df['Close'].pct_change(20)
        df['Mayer'] = df['Close'] / df['SMA_200']
        data_map[symbol] = df

    today = data_map['BTC'].index[-1]
    vix = data_map['VIX'].loc[today]['Close'] if 'VIX' in data_map else 20
    row_btc = data_map['BTC'].loc[today]
    row_eth = data_map['ETH'].loc[today]
    
    is_panic = vix > 30
    bull_btc = row_btc['Close'] > row_btc['SMA_140']
    
    # è¡›æ˜Ÿé¸å¹£ (å°é½Šçµ‚æ¥µç‰ˆï¼šç´”å‹•èƒ½ + 0.8x è»Ÿæ€§æ¿å¡Šæ‡²ç½°)
    candidates = []
    for sym, sector in ticker_to_sector.items():
        if sym not in data_map: continue
        r = data_map[sym].loc[today]
        if r['Close'] > r['SMA_60'] and r['Ret_20'] > row_btc['Ret_20']:
            candidates.append({'sym': sym, 'score': r['Ret_20'], 'sector': sector})
    
    candidates.sort(key=lambda x: x['score'], reverse=True)
    top = []
    if candidates:
        top.append(candidates[0])
        if len(candidates) > 1:
            f_sec = candidates[0]['sector']
            challenger = sorted([{**c, 'adj': c['score']*0.8 if c['sector']==f_sec else c['score']} for c in candidates[1:]], key=lambda x: x['adj'], reverse=True)[0]
            top.append(challenger)

    # ç›®æ¨™åˆ†é… (90/10 é€€ä¼‘çµæ§‹)
    tw = {'BTC': 0.0, 'ETH': 0.0, 'SAT1': 0.0, 'SAT2': 0.0}
    ss = {'SAT1': 'NONE', 'SAT2': 'NONE'}

    if not is_panic and bull_btc:
        # é€²æ”»ä¸Šé™å„ªåŒ–ï¼šæ ¸å¿ƒ 80% (50/30) + è¡›æ˜Ÿ 10% = 90%ã€‚å‰©é¤˜ 10% æŒæœ‰ç¾é‡‘é ˜æ¯ã€‚
        sat_alloc = 0.10 
        
        # Sentinel æ ¸å¿ƒåŒ¯ç‡åˆ¤æ–·
        eth_btc_series = data_map['ETH']['Close'] / data_map['BTC']['Close']
        is_eth_strong = (row_eth['Close']/row_btc['Close']) > eth_btc_series.rolling(50).mean().iloc[-1]

        if is_eth_strong and row_eth['Close'] > row_eth['SMA_140']:
            # ğŸš€ é€€ä¼‘é€²æ”»æ¨¡å¼: 50% BTC / 30% ETH (é–æ­»ä¸Šé™)
            tw['BTC'], tw['ETH'] = 0.50, 0.30
        else:
            # ğŸ›¡ï¸ é€€ä¼‘é˜²ç¦¦æ¨¡å¼ (æ ¸å¿ƒ 90% ä¹‹ 75% çµ¦ BTC)
            tw['BTC'], tw['ETH'] = 0.675, 0.225
            
        for i, t in enumerate(top):
            key = f'SAT{i+1}'; tw[key] = sat_alloc / 2; ss[key] = t['sym']

    return tw, ss, vix, row_btc['Mayer'], bull_btc, today

# ==========================================
# 2. æˆ°å ±ç”Ÿæˆæ¨¡çµ„ (10% åŠ è–ªèˆ‡ 3x å¸³ç¯·)
# ==========================================
def generate_retirement_report():
    tw, ss, vix, mayer, is_bull, dt = analyze_retirement_market()
    
    # --- è¨ˆç®—é€€ä¼‘è–ªè³‡ ---
    years_passed = max(0, dt.year - USER_ACCOUNT['RETIRE_YEAR'])
    current_monthly_salary = USER_ACCOUNT['INITIAL_SALARY_TWD'] * (1 + USER_ACCOUNT['SALARY_GROWTH']) ** years_passed
    
    # --- è³‡ç”¢ç¸½çµ ---
    tent_twd = USER_ACCOUNT['BANK_CASH_TWD']
    crypto_twd = USER_ACCOUNT['CRYPTO_EQUITY_USDT'] * USD_TWD_RATE
    total_assets_twd = tent_twd + crypto_twd
    
    # --- å¸³ç¯·å¯©è¨ˆ (3å€æ³•å‰‡) ---
    ideal_tent = current_monthly_salary * 12 * 3
    tent_health = (tent_twd / ideal_tent) * 100
    
    # --- ææ¬¾æ¨¡å¼ ---
    is_slow = total_assets_twd < SAFE_BARRIER_TWD
    final_pay = current_monthly_salary if not is_slow else current_monthly_salary * 0.8

    # --- è¨Šæ¯æ§‹å»º ---
    msg = f"ğŸ° V44 Sentinel é€€ä¼‘æŒ‡æ®å®˜ (v8.8)\n"
    msg += f"ğŸ“… æ—¥æœŸ: {dt.strftime('%Y-%m-%d')}\n"
    msg += f"ğŸ’° ç¸½è³‡ç”¢: ${total_assets_twd/10000:,.1f} è¬ TWD\n"
    msg += f"ğŸš© éšæ®µ: é€€ä¼‘ç¬¬ {years_passed+1} å¹´ (åŠ è–ª 10%)\n"
    msg += f"ğŸŒ ç’°å¢ƒ: {'ğŸŸ¢é€²æ”»' if is_bull else 'ğŸ›¡ï¸é¿éšª'} (VIX {vix:.1f} | Mayer {mayer:.2f})\n"
    msg += "----------------------------\n"

    # å®‰å…¨èˆ‡ææ¬¾
    msg += f"ğŸ“Š [é€€ä¼‘å®‰å…¨å¯©è¨ˆ]\n"
    msg += f"â€¢ æœ¬æœˆæ‡‰é ˜æœˆè–ª: ${final_pay:,.0f} TWD" + (" (ğŸš¨æ¸›é€Ÿ)" if is_slow else "") + "\n"
    msg += f"â€¢ å¸³ç¯·å¥åº·åº¦: {tent_health:.1f}%\n"
    if tent_health < 100 and total_assets_twd > SAFE_BARRIER_TWD:
        msg += f"ğŸ‘‰ å»ºè­°å‡ºé‡‘ ${ (ideal_tent - tent_twd):,.0f} è£œè¶³å¸³ç¯·\n"
    else:
        msg += f"âœ… å¸³ç¯·æ°´ä½å……è¶³ï¼Œé˜²ç·šç©©å›ºã€‚\n"
    msg += "----------------------------\n"

    # äº¤æ˜“æŒ‡ä»¤
    msg += f"ğŸ“ [Lean 15 å¯¦æˆ°æŒ‡ä»¤]\n"
    assets = [
        ('BTC', USER_ACCOUNT['CURRENT_BTC_W'], tw['BTC']),
        ('ETH', USER_ACCOUNT['CURRENT_ETH_W'], tw['ETH']),
        (f"è¡›æ˜Ÿ1:{ss['SAT1']}", USER_ACCOUNT['CURRENT_SAT_1_W'], tw['SAT1']),
        (f"è¡›æ˜Ÿ2:{ss['SAT2']}", USER_ACCOUNT['CURRENT_SAT_2_W'], tw['SAT2'])
    ]

    for name, curr, target in assets:
        diff = target - curr
        action = "âœ…çºŒæŠ±"
        if target == 0 and curr > 0.01: action = "ğŸš¨ç«‹å³æ¸…å€‰"
        elif abs(diff) > REBALANCE_THRESHOLD: action = "ğŸ””å»ºè­°èª¿å€‰"
        msg += f"â€¢ {name}: {action} (ç›®æ¨™ {target*100:.1f}%)\n"

    msg += "----------------------------\n"
    if is_bull:
        msg += f"ğŸŸ¢ [ææ¬¾æŒ‡å¼•] è³£å¹£æé ˜ ${final_pay:,.0f}ã€‚\n"
        msg += f"ğŸ‘‰ åˆ©æ¯å…¨é¡è¤‡åˆ©ä¸­ï¼Œææ¬¾è¦–ç‚ºä¿®å‰ªæ¨¹æã€‚"
    else:
        msg += f"ğŸ›¡ï¸ [ææ¬¾æŒ‡å¼•] ä½¿ç”¨åˆ©æ¯/ç¾é‡‘å¸³ç¯·æé ˜ã€‚\n"
        msg += f"ğŸ‘‰ æŒ‡ä»¤ï¼šè«‹ç¢ºèªè³‡é‡‘å·²å­˜å…¥ç”Ÿæ¯å”è­°é¿éšªã€‚"
    
    return msg

if __name__ == "__main__":
    try:
        report = generate_retirement_report()
        send_line_push(report)
    except Exception as e:
        err_msg = f"âŒ æŒ‡æ®å®˜åŸ·è¡Œå‡ºéŒ¯: {str(e)}"
        print(err_msg); send_line_push(err_msg)
