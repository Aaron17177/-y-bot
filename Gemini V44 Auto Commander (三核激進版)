# ==========================================
# Gemini V44 Auto Commander (ä¸‰æ ¸æ¿€é€²ç‰ˆ) - THE CHAMPION
# ------------------------------------------
# ç¶“é WFV åš´æ ¼å›æ¸¬ï¼Œæ“Šæ•— V37, V41, V45, V46
# æ­·å²æˆ°ç¸¾ (2021-Now): å ±é…¬ç‡ +1009% | æœ€å¤§å›æ’¤ -34.3%
# ------------------------------------------
# è³‡é‡‘é…ç½®ï¼š40% BTC + 40% ETH + 20% SOL
# ç­–ç•¥é‚è¼¯ (The Trinity):
# 1. è¶¨å‹¢éµå¾‹: åƒ¹æ ¼ > SMA 140 (20é€±ç·š) -> æŒæœ‰
# 2. è¡›æ˜Ÿé¢¨æ§: SOL è²·å…¥å‰ææ˜¯ BTC å¿…é ˆè™•æ–¼ç‰›å¸‚ (å¤§å“¥æ¿¾ç¶²)
# 3. é¿éšªæ¿¾ç¶²: VIX > 30 (ææ…Œ) æˆ– Mayer > 2.4 (éç†±) -> æ¸›ç¢¼/ç©ºå€‰
# 4. æŠ„åº•æ©Ÿåˆ¶: ç†Šå¸‚ä¸­ RSI < 30 -> æ¶åå½ˆ (30% å€‰ä½)
# ==========================================

import os
import sys
import requests
import json
import warnings
import pandas as pd
import numpy as np
from datetime import datetime, timedelta

warnings.filterwarnings("ignore")

# ==========================================
# 0. ç’°å¢ƒæª¢æŸ¥èˆ‡ LINE è¨­å®š
# ==========================================
print("="*50)
print("ğŸ” V44 ç³»çµ±å•Ÿå‹•è‡ªæˆ‘è¨ºæ–·...")

LINE_CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
LINE_USER_ID = os.environ.get('LINE_USER_ID')

if LINE_CHANNEL_ACCESS_TOKEN:
    print(f"âœ… Token è®€å–æˆåŠŸï¼å‰äº”ç¢¼: {LINE_CHANNEL_ACCESS_TOKEN[:5]}...")
else:
    print("âŒ åš´é‡éŒ¯èª¤ï¼šToken æ˜¯ç©ºçš„ï¼è«‹æª¢æŸ¥ GitHub Secretsã€‚")

if LINE_USER_ID:
    print(f"âœ… UserID è®€å–æˆåŠŸï¼User ID: {LINE_USER_ID}")
else:
    print("âŒ åš´é‡éŒ¯èª¤ï¼šUser ID æ˜¯ç©ºçš„ï¼")

def send_line_push(msg, is_test=False):
    if not LINE_CHANNEL_ACCESS_TOKEN or not LINE_USER_ID:
        if is_test: sys.exit(1)
        return False
    
    url = 'https://api.line.me/v2/bot/message/push'
    headers = {
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {LINE_CHANNEL_ACCESS_TOKEN}'
    }
    payload = {
        "to": LINE_USER_ID,
        "messages": [{"type": "text", "text": msg}]
    }
    try:
        requests.post(url, headers=headers, json=payload)
        print("âœ… LINE ç™¼é€æˆåŠŸ")
        return True
    except Exception as e:
        print(f"âŒ ç™¼é€å¤±æ•—ï¼éŒ¯èª¤: {e}")
        if is_test: sys.exit(1)
        return False

# ç«‹å³æ¸¬è©¦é€£ç·š
if not send_line_push("ğŸ”” ã€ç³»çµ±æ¸¬è©¦ã€‘Gemini V44 (BTC/ETH/SOL) å•Ÿå‹•ä¸­...", is_test=True):
    sys.exit(1)

# è‡ªå‹•å®‰è£å¿…è¦å¥—ä»¶ (yfinance)
try:
    import yfinance as yf
except ImportError:
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
    import yfinance as yf

# ==========================================
# 1. æ•¸æ“šä¸­å¿ƒ
# ==========================================
print("ğŸ“¥ æ­£åœ¨é€£ç·šå…¨çƒæ•¸æ“šåº« (BTC, ETH, SOL)...")

# æŠ“å–è¶³å¤ é•·çš„æ­·å²æ•¸æ“šä»¥è¨ˆç®—å‡ç·š
START_DATE = '2020-01-01' 
tickers = ['BTC-USD', 'ETH-USD', 'SOL-USD', '^VIX']

try:
    raw_data = yf.download(tickers, start=START_DATE, group_by='ticker', progress=False)
except Exception as e:
    print(f"âŒ æ•¸æ“šä¸‹è¼‰å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯ã€‚éŒ¯èª¤: {e}")
    sys.exit()

def get_data(ticker):
    df = pd.DataFrame()
    try:
        if ticker in raw_data.columns.levels[0]:
            df['Close'] = raw_data[ticker]['Close']
        else:
            if ticker == 'BTC-USD': df['Close'] = raw_data['Close']
    except:
        return None
    
    # è™•ç† VIX
    try:
        if '^VIX' in raw_data.columns.levels[0]:
            df['VIX'] = raw_data['^VIX']['Close']
        else:
            df['VIX'] = 20.0
    except:
        df['VIX'] = 20.0

    df.ffill(inplace=True)
    df.dropna(inplace=True)
    return df

df_btc = get_data('BTC-USD')
df_eth = get_data('ETH-USD')
df_sol = get_data('SOL-USD')

# ==========================================
# 2. ç­–ç•¥å¼•æ“ (V44 Logic)
# ==========================================
def analyze_asset(df, asset_name, btc_trend=True):
    # A. è¨ˆç®—æŒ‡æ¨™
    df['SMA_140'] = df['Close'].rolling(window=140).mean()
    df['SMA_200'] = df['Close'].rolling(window=200).mean()
    df['Mayer'] = df['Close'] / df['SMA_200']
    
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))
    
    latest = df.iloc[-1]
    
    # --- åˆ¤æ–·é‚è¼¯ ---
    price = latest['Close']
    sma140 = latest['SMA_140']
    mayer = latest['Mayer']
    vix = latest['VIX']
    rsi = latest['RSI']
    
    target_pct = 0.0
    status = ""
    reason = ""
    
    is_bull = price > sma140
    is_panic = vix > 30
    is_overheated = mayer > 2.4
    is_oversold = rsi < 30
    
    # [SOL å°ˆå±¬é¢¨æ§] å¤§å“¥æ¿¾ç¶²
    if asset_name == "Solana" and not btc_trend:
        return {
            'name': asset_name, 'price': price, 'sma140': sma140,
            'target_pct': 0.0, 'status': "ğŸ›‘ è¯å‹•é¿éšª", 
            'reason': "BTC è½‰å…¥ç†Šå¸‚ï¼Œå¼·åˆ¶ç©ºå€‰ä¿è­·ã€‚", 'is_bull': False, 'vix': vix
        }

    # ä¸€èˆ¬ä¸‰å±¤åˆ¤æ–· (ææ…Œ > éç†± > è¶¨å‹¢ > æŠ„åº•)
    if is_panic:
        target_pct = 0.0
        status = "ğŸŒªï¸ ææ…Œé¿éšª"
        reason = f"VIX ({vix:.2f}) éé«˜ï¼Œç³»çµ±æ€§é¢¨éšªã€‚"
    elif is_overheated:
        target_pct = 0.5
        status = "âš ï¸ éç†±æ¸›ç¢¼"
        reason = f"Mayer ({mayer:.2f}) éç†±ï¼Œé–å®šåˆ©æ½¤ã€‚"
    elif is_bull:
        target_pct = 1.0
        status = "ğŸš€ è¶¨å‹¢æŒæœ‰"
        reason = "ç«™ç©© SMA 140ï¼Œé †å‹¢æ“ä½œã€‚"
    else: # ç†Šå¸‚
        if is_oversold:
            target_pct = 0.3
            status = "âš¡ æ¥µé™æŠ„åº•"
            reason = f"RSI ({rsi:.1f}) è¶…è³£ï¼Œæ¶çŸ­ç·šåå½ˆã€‚"
        else:
            target_pct = 0.0
            status = "ğŸ›‘ ç©ºå€‰è§€æœ›"
            reason = "è·Œç ´ SMA 140ï¼Œç©ºå€‰ä¿æœ¬ã€‚"
            
    return {
        'name': asset_name,
        'price': price,
        'sma140': sma140,
        'target_pct': target_pct,
        'status': status,
        'reason': reason,
        'is_bull': is_bull,
        'vix': vix
    }

# ==========================================
# 3. ç”ŸæˆæŠ•è³‡çµ„åˆå»ºè­°
# ==========================================
print("ğŸ§  AI æ­£åœ¨åˆ†æä¸‰æ ¸é…ç½® (40/40/20)...")

# 1. å…ˆåˆ†æ BTC (å¤§å“¥ç‹€æ…‹)
btc_signal = analyze_asset(df_btc, "Bitcoin")
btc_is_bull = btc_signal['is_bull']

# 2. åˆ†æ ETH (æ ¸å¿ƒ) å’Œ SOL (è¡›æ˜Ÿ)
eth_signal = analyze_asset(df_eth, "Ethereum")
sol_signal = analyze_asset(df_sol, "Solana", btc_trend=btc_is_bull)

# 3. è¨ˆç®—æ¬Šé‡ (V44 æ¿€é€²é…ç½®: 40 / 40 / 20)
w_btc = btc_signal['target_pct'] * 0.40
w_eth = eth_signal['target_pct'] * 0.40
w_sol = sol_signal['target_pct'] * 0.20
w_cash = 1.0 - (w_btc + w_eth + w_sol)

latest_date = df_btc.index[-1].strftime('%Y-%m-%d')
vix_level = btc_signal['vix']
next_check = (datetime.now() + timedelta(days=180)).strftime('%Y-%m-%d')

# 4. çµ„åˆè¨Šæ¯
message = f"""
=========================
ğŸ† Gemini V44 æ¿€é€²ä¸‰æ ¸æˆ°å ±
ğŸ“… æ—¥æœŸ: {latest_date} | VIX: {vix_level:.2f}
=========================

ğŸŸ  [BTC] (æ ¸å¿ƒ 40%)
   ${btc_signal['price']:,.0f} (å‡ç·š ${btc_signal['sma140']:,.0f})
   æŒ‡ä»¤: {btc_signal['status']} ({btc_signal['target_pct']*100:.0f}%)
   ç†ç”±: {btc_signal['reason']}

ğŸ”µ [ETH] (æ ¸å¿ƒ 40%)
   ${eth_signal['price']:,.0f} (å‡ç·š ${eth_signal['sma140']:,.0f})
   æŒ‡ä»¤: {eth_signal['status']} ({eth_signal['target_pct']*100:.0f}%)
   ç†ç”±: {eth_signal['reason']}

ğŸŸ£ [SOL] (è¡›æ˜Ÿ 20%)
   ${sol_signal['price']:,.2f} (å‡ç·š ${sol_signal['sma140']:,.2f})
   æŒ‡ä»¤: {sol_signal['status']} ({sol_signal['target_pct']*100:.0f}%)
   ç†ç”±: {sol_signal['reason']}

-------------------------
ğŸ’¼ [ç¸½è³‡ç”¢å»ºè­°é…ç½®] (Target Allocation)
   ğŸŸ  BTC : {w_btc*100:>4.1f}%
   ğŸ”µ ETH : {w_eth*100:>4.1f}%
   ğŸŸ£ SOL : {w_sol*100:>4.1f}%
   ğŸŸ¢ Cash: {w_cash*100:>4.1f}%
-------------------------

ğŸ’¡ ç´€å¾‹æé†’:
1. SOL æ³¢å‹•å¤§ï¼Œåš´æ ¼éµå®ˆ 20% ä¸Šé™ã€‚
2. è‹¥ SOL ä½”ç¸½è³‡ç”¢ > 25%ï¼Œè«‹å¼·åˆ¶è³£å‡ºå¤šé¤˜éƒ¨åˆ† (æ”¶å‰²)ã€‚
3. ç†Šå¸‚ç´€å¾‹ï¼šBTC è½‰ç©º (ğŸ›‘) æ™‚ï¼ŒSOL å¿…é ˆæ¸…å€‰ï¼Œä¸å¯æˆ€æˆ°ã€‚

ğŸ“… [AI å¥æª¢] è«‹æ–¼ {next_check} æª¢æŸ¥åƒæ•¸ã€‚
=========================
"""

# 4. ç™¼é€å ±å‘Š
print("ğŸ“¤ ç™¼é€æˆ°å ±...")
print(message)
send_line_push(message)
